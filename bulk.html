<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printify Bulk Product Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js" integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin="anonymous" referrerpolicy="no-referrer" async=""></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .step-container {
            display: none;
        }
        .step-container.active {
            display: block;
        }
        .product-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }
        .product-card {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .product-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            height: 100%;
            text-align: center;
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
            background-color: transparent;
            border: 1px solid #dee2e6;
        }

        .product-info h6 {
            font-size: 0.9rem;
            margin-bottom: 4px;
            line-height: 1.2;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-info small {
            font-size: 0.75rem;
        }
        .product-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        }
        .product-card.selected {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .bulk-print-area-table {
            overflow-x: auto;
        }
        .print-area-cell {
            min-width: 120px;
            text-align: center;
            vertical-align: middle;
        }
        .design-preview-small {
            max-width: 50px;
            max-height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
        .bulk-design-assignment {
            background-color: transparent;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .selected-products-count {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
    </style>
    <style>
        :root {
            --primary: #0ea5e9;      /* teal sky */
            --primary-600: #0284c7;  /* deeper sky */
            --secondary: #14b8a6;    /* teal */
            --success: #22c55e;      /* emerald */
            --surface: #ffffff;
            --muted: #64748b;        /* slate-500 */
            --radius: 12px;
            --shadow: 0 8px 24px rgba(2, 6, 23, 0.06);
        }

        body {
            background: linear-gradient(180deg, #f8fafc, #ffffff 50%);
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            color: #0f172a;
        }

        .navbar {
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.06);
        }
        .navbar.navbar-dark.bg-dark {
            background: linear-gradient(135deg, #0b1220, #0f172a 40%, #0b3a4c) !important;
        }
        .navbar .nav-link:hover, .navbar .navbar-brand:hover {
            color: #bae6fd !important;
        }

        .card {
            border: 1px solid #e5e7eb;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-600));
            border: none;
        }
        .btn-primary:hover {
            filter: brightness(0.98);
            transform: translateY(-1px);
        }
        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
        }
        .btn-outline-primary {
            color: var(--primary-600);
            border-color: var(--primary-600);
        }
        .btn-outline-primary:hover {
            background: var(--primary-600);
            color: #fff;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 .14rem rgba(14, 165, 233, .28);
        }

        .step-indicator { gap: 12px; }
        .step-indicator .step {
            background: #f1f5f9;
            border-radius: var(--radius);
            border: 1px solid #e2e8f0;
            padding: 14px;
            transition: all .2s ease;
        }
        .step-indicator .step.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-600));
            color: #fff;
            box-shadow: 0 8px 18px rgba(2, 132, 199, .25);
        }
        .step-indicator .step.completed {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
        }

        .product-card {
            border: 1px solid #e2e8f0;
            border-radius: var(--radius);
            transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 26px rgba(2, 6, 23, 0.08);
            border-color: #bae6fd; /* light sky */
        }
        .product-card.selected {
            border-color: #22c55e;
            background: linear-gradient(180deg, #f0fdf4, #ffffff);
        }

        .product-image {
            border-radius: 10px;
            background: #fff;
        }

        .bulk-design-assignment {
            background: #ffffff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .selected-products-count {
            border-bottom: 1px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: saturate(1.1) blur(6px);
        }

        .loading-spinner {
            border-color: #e5e7eb;
            border-top-color: var(--primary);
        }

        .badge.bg-secondary {
            background: linear-gradient(135deg, #94a3b8, #64748b) !important;
        }

        .mockup-preview img {
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 16px rgba(2, 6, 23, 0.08);
        }

        .table {
            --bs-table-striped-bg: #f8fafc;
            --bs-table-hover-bg: #f1f5f9;
        }
        .table thead th {
            background: #f1f5f9;
            color: #0f172a;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        .table tbody tr + tr td {
            border-top-color: #eef2f7;
        }

        #generateStatus .alert {
            border-radius: 10px;
            box-shadow: 0 8px 18px rgba(2, 6, 23, 0.08);
        }

        .small-muted { color: #64748b; }

        /* Headings polish without changing markup */
        h1, h4, h5 { letter-spacing: -0.015em; }
        h1 { font-weight: 700; }
        h4 { font-weight: 600; }
        h5 { font-weight: 600; color: #0f172a; }

        /* Subtle custom scrollbar for modern feel (non-functional change) */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--primary-600));
            border-radius: 999px;
        }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="index.html">Printify Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Create Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="bulk.html">Bulk Creator</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="pricing.html">Manage Pricing</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="inspiration.html">Search Inspiration</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4"><i class="bi bi-layers"></i> Bulk Product Creator</h1>
        
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <i class="bi bi-key"></i><br>
                <small>API Setup</small>
            </div>
            <div class="step" id="step2">
                <i class="bi bi-shop"></i><br>
                <small>Select Shop</small>
            </div>
            <div class="step" id="step3">
                <i class="bi bi-check-square"></i><br>
                <small>Select Products</small>
            </div>
            <div class="step" id="step4">
                <i class="bi bi-magic"></i><br>
                <small>Generate Designs</small>
            </div>
            <div class="step" id="step5">
                <i class="bi bi-table"></i><br>
                <small>Assign Print Areas</small>
            </div>
        </div>

        <!-- Step 1: API Setup -->
        <div class="step-container active" id="step1-container">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-key"></i> API Setup</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="apiKey" class="form-label">Printify API Key</label>
                        <input type="password" class="form-control" id="apiKey" placeholder="Enter your Printify API key">
                        <div class="form-text">
                            Get your API key from <a href="https://printify.com/app/account/api" target="_blank">Printify Account → API</a>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="verifyApiBtn">
                        <i class="bi bi-shield-check"></i> Verify API Key
                    </button>
                    <div id="apiStatus" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Step 2: Shop Selection -->
        <div class="step-container" id="step2-container">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-shop"></i> Select Shop</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="shopSelect" class="form-label">Choose your Printify shop</label>
                        <select class="form-select" id="shopSelect">
                            <option value="">Loading shops...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="selectShopBtn" disabled>
                        <i class="bi bi-arrow-right"></i> Continue
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Product Selection -->
        <div class="step-container" id="step3-container">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-box"></i> Select Products</h4>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" id="selectAllBtn">Select All</button>
                            <button class="btn btn-outline-secondary btn-sm" id="clearAllBtn">Clear All</button>
                        </div>
                    </div>
                    
                    <div id="productsGrid" class="row">
                        <!-- Products will be loaded here -->
                    </div>
                    <div id="paginationControls" class="d-flex justify-content-center mt-4"></div>
                    
                    <div class="mt-3">
                        <p><strong>Selected:</strong> <span id="selectedCount">0</span> products</p>
                        <button class="btn btn-primary" id="selectProductsBtn" disabled>
                            <i class="bi bi-arrow-right"></i> Continue to Design
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Bulk Design Generation -->
        <div class="step-container" id="step4-container">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-magic"></i> Generate Designs for Bulk Creation</h4>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="designTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-content" type="button">AI Generation</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-content" type="button">Upload Images</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="ai-content">
                            <div class="mb-3">
                                <label for="designPrompt" class="form-label">Design Description</label>
                                <textarea class="form-control" id="designPrompt" rows="3" placeholder="Enter design prompt for all products..."></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="numDesigns" class="form-label">Number of Designs</label>
                                    <select class="form-select" id="numDesigns">
                                        <option value="1">1 Design</option>
                                        <option value="3" selected>3 Designs</option>
                                        <option value="5">5 Designs</option>
                                        <option value="10">10 Designs</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="aiModel" class="form-label">AI Model</label>
                                    <select class="form-select" id="aiModel">
                                        <option value="flux-pro">Flux Pro</option>
                                        <option value="flux-dev" selected>Flux Dev</option>
                                        <option value="recraft-v3">Recraft V3</option>
                                        <option value="imagen4-preview">Imagen 4 Preview</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary" id="generateBulkDesignsBtn">
                                <i class="bi bi-stars"></i> Generate All Designs
                            </button>
                        </div>
                        
                        <div class="tab-pane fade" id="upload-content">
                            <div class="mb-3">
                                <label for="bulkImageUpload" class="form-label">Upload Your Images</label>
                                <input class="form-control" type="file" id="bulkImageUpload" accept="image/*" multiple>
                                <div class="form-text">Images will be used across all selected products.</div>
                            </div>
                            <button class="btn btn-primary" id="bulkUploadBtn">
                                <i class="bi bi-cloud-arrow-up"></i> Upload Images
                            </button>
                        </div>
                    </div>
                    
                    <div id="bulkGenerateStatus" class="mt-3"></div>
                    
                    <div class="row" id="bulkDesignsList"></div>
                    
                    <button class="btn btn-primary" id="continueToAssignmentBtn" disabled>
                        <i class="bi bi-arrow-right"></i> Continue to Print Area Assignment
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 5: Print Area Assignment -->
        <div class="step-container" id="step5-container">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-check-circle"></i> Print Area Assignment</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Product Details</h5>
                            <div class="mb-3">
                                <label for="bulkProductTitle" class="form-label">Product Title Template</label>
                                <input type="text" class="form-control" id="bulkProductTitle" placeholder="e.g., {product_name} - Custom Design">
                                <div class="form-text">Use {product_name} as placeholder for product type</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="bulkProductDescription" class="form-label">Product Description Template</label>
                                <textarea class="form-control" id="bulkProductDescription" rows="4" placeholder="Enter product description template..."></textarea>
                                <div class="form-text">Use {product_name} as placeholder for product type</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="bulkProductTags" class="form-label">Product Tags</label>
                                <input type="text" class="form-control" id="bulkProductTags" placeholder="Enter tags separated by commas">
                            </div>
                            
                            <div class="mb-3">
                                <button class="btn btn-primary" id="generateAiContentBtn_step5">
                                    <i class="bi bi-robot"></i> Generate AI Content for All Products
                                </button>
                            </div>
                            
                            <h5>Variants & Pricing</h5>
                            <div id="bulkVariantsList"></div>
                            
                            <button class="btn btn-success" id="createBulkProductsBtn" disabled>
                                <i class="bi bi-plus-circle"></i> Create All Products
                            </button>
                        </div>
                        
                        <div class="col-md-6">
                            
                            <h5>Product Preview</h5>
                            <div id="bulkProductPreview"></div>
                            
                            <h5>Design Assignments</h5>
                            <div id="bulkDesignAssignmentsSummary"></div>
                        </div>
                    </div>
                    
                    <div class="table-responsive mt-4">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Print Areas</th>
                                    <th>Design</th>
                                                </tr>
                            </thead>
                            <tbody id="assignmentTableBody">
                                <!-- Assignment rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // --- API HELPER FUNCTION ---
            async function makeApiCall(endpoint, options = {}) {
                const { method = 'GET', body } = options;
                
                const response = await fetch('/.netlify/functions/printify-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${BulkAppState.apiKey}`
                    },
                    body: JSON.stringify({
                        endpoint,
                        method,
                        body
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || `API Error: ${response.status}`);
                }
                
                return result.data;
            }

            // --- GLOBAL STATE --- 
            const BulkAppState = {
                apiKey: '',
                shops: [],
                selectedShop: null,
                allBlueprints: [],
                filteredBlueprints: [],
                currentPage: 1,
                pageSize: 24, // 4 rows of 6 products
                selectedBlueprint: null,
                selectedProvider: null,
                variants: [],
                selectedVariants: new Set(),
                generatedDesigns: [],
                selectedDesign: null,
                printAreas: [],
                designAssignments: new Map(),
                selectedProducts: new Set(), // Track selected products
                productAssignments: new Map(), // Track product-provider mappings
                bulkSettings: {
                    titleTemplate: '',
                    descriptionTemplate: '',
                    tags: []
                }
            };

        // --- UTILITY FUNCTIONS ---
        function showStep(stepNumber) {
            document.querySelectorAll('.step-container').forEach(container => container.classList.remove('active'));
            document.getElementById(`step${stepNumber}-container`).classList.add('active');
            document.querySelectorAll('.step-indicator .step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 === stepNumber) step.classList.add('active');
                else if (index + 1 < stepNumber) step.classList.add('completed');
            });
        }

        function updateSelectedCount() {
            const count = BulkAppState.selectedProducts.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('selectProductsBtn').disabled = count === 0;
            // document.getElementById('summaryProductCount').textContent = count;
        }

        function showError(message) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        function validateApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const verifyBtn = document.getElementById('verifyApiBtn');
            verifyBtn.disabled = !apiKey;
        }

        // --- STEP 1: API & SHOP --- 
        async function verifyApiKeyAndLoadShops() {
            const apiKeyInput = document.getElementById('apiKey');
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert('Please enter your Printify API Key.');
                return;
            }
            BulkAppState.apiKey = apiKey;
            const statusDiv = document.getElementById('apiStatus');
            
            try {
                const shops = await makeApiCall('/shops.json');
                if (!shops || shops.length === 0) throw new Error('No shops found for this API key.');
                
                BulkAppState.shops = shops;
                localStorage.setItem('printifyApiKey', apiKey);
                statusDiv.innerHTML = `<div class="alert alert-success">API Key is valid. Found ${shops.length} shop(s).</div>`;
                
                const shopSelect = document.getElementById('shopSelect');
                shopSelect.innerHTML = '<option value="">-- Select a Shop --</option>';
                shops.forEach(shop => {
                    shopSelect.innerHTML += `<option value="${shop.id}">${shop.title}</option>`;
                });
                
                // Enable the shop selection button
                document.getElementById('selectShopBtn').disabled = false;
                
                setTimeout(() => showStep(2), 500);
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        // --- STEP 2: PRODUCT SELECTION ---
        async function loadBulkBlueprints() {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Loading products...</div>';
            
            try {
                const blueprints = await makeApiCall('/catalog/blueprints.json');
                BulkAppState.allBlueprints = blueprints;
                BulkAppState.filteredBlueprints = blueprints;
                
                displayProductsPage(1);
                setupProductSelectionEvents();
                
            } catch (error) {
                productsGrid.innerHTML = `<div class="alert alert-danger">Error loading products: ${error.message}</div>`;
                alert(`Error loading products: ${error.message}`);
            }
        }

        function createProductGroup(brandName, products) {
            return `
                <div class="col-12 mb-3">
                    <h5>${brandName}</h5>
                    <div class="row">
                        ${products.map(product => `
                            <div class="col-md-3 col-lg-2 mb-3">
                                <div class="product-card" data-product-id="${product.id}" data-product-title="${product.title}">
                                    <input type="checkbox" class="product-checkbox form-check-input" data-product-id="${product.id}">
                                    <img src="${product.thumbnail_url || product.images?.[0] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik00MCA0MEw0NSAzNUw1MCA0MEw0NSA0NUw0MCA0MFoiIGZpbGw9IiM5Qjk5OUIiLz4KPC9zdmc+Cg=='}" 
                                 alt="${product.title}" class="product-image" 
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik00MCA0MEw0NSAzNUw1MCA0MEw0NSA0NUw0MCA0MFoiIGZpbGw9IiM5Qjk5OUIiLz4KPC9zdmc+Cg=='">
                                    <div class="product-info">
                                        <h6>${product.title}</h6>
                                        <small class="text-muted">${product.brand || 'Generic'}</small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function displayProductsPage(page) {
            BulkAppState.currentPage = page;
            const productsGrid = document.getElementById('productsGrid');
            const { filteredBlueprints, pageSize } = BulkAppState;

            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageBlueprints = filteredBlueprints.slice(startIndex, endIndex);

            const brandGroups = {};
            pageBlueprints.forEach(bp => {
                const brand = bp.brand || 'Other';
                if (!brandGroups[brand]) brandGroups[brand] = [];
                brandGroups[brand].push(bp);
            });

            productsGrid.innerHTML = '';
            Object.keys(brandGroups).sort().forEach(brand => {
                if (brandGroups[brand].length > 0) {
                    const groupHtml = createProductGroup(brand, brandGroups[brand]);
                    productsGrid.innerHTML += groupHtml;
                }
            });

            setupPaginationControls();
        }

        function setupPaginationControls() {
            const { currentPage, pageSize, filteredBlueprints } = BulkAppState;
            const totalPages = Math.ceil(filteredBlueprints.length / pageSize);
            const paginationControls = document.getElementById('paginationControls');

            if (totalPages <= 1) {
                paginationControls.innerHTML = '';
                return;
            }

            let paginationHtml = '<nav><ul class="pagination">';

            // Previous button
            paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="displayProductsPage(${currentPage - 1})">Previous</a></li>`;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${currentPage === i ? 'active' : ''}"><a class="page-link" href="#" onclick="displayProductsPage(${i})">${i}</a></li>`;
            }

            // Next button
            paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="displayProductsPage(${currentPage + 1})">Next</a></li>`;

            paginationHtml += '</ul></nav>';
            paginationControls.innerHTML = paginationHtml;
        }

        function setupProductSelectionEvents() {
            // Use event delegation for dynamic content
            document.getElementById('productsGrid').addEventListener('click', function(e) {
                if (e.target.classList.contains('product-checkbox')) {
                    handleProductSelection(e.target);
                } else if (e.target.closest('.product-card')) {
                    const card = e.target.closest('.product-card');
                    const checkbox = card.querySelector('.product-checkbox');
                    if (!e.target.classList.contains('product-checkbox')) {
                        checkbox.checked = !checkbox.checked;
                        handleProductSelection(checkbox);
                    }
                }
            });

            // Select/Clear All buttons
            document.getElementById('selectAllBtn').addEventListener('click', () => {
                document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                    handleProductSelection(checkbox);
                });
            });

            document.getElementById('clearAllBtn').addEventListener('click', () => {
                document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                    handleProductSelection(checkbox);
                });
            });

            // Product search
            document.getElementById('productSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                BulkAppState.filteredBlueprints = BulkAppState.allBlueprints.filter(bp => {
                    const title = bp.title.toLowerCase();
                    const brand = (bp.brand || 'Other').toLowerCase();
                    return title.includes(searchTerm) || brand.includes(searchTerm);
                });
                displayProductsPage(1);
            });

            // Clear search
            document.getElementById('clearSearchBtn').addEventListener('click', () => {
                document.getElementById('productSearch').value = '';
                BulkAppState.filteredBlueprints = BulkAppState.allBlueprints;
                displayProductsPage(1);
            });
        }

        async function loadProvidersForSelectedProducts() {
            const selectedProducts = Array.from(BulkAppState.selectedProducts);
            if (selectedProducts.length === 0) {
                alert('Please select at least one product');
                return;
            }

            const statusDiv = document.createElement('div');
            statusDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Loading providers for selected products...</div>';
            document.getElementById('step3-container').appendChild(statusDiv);

            BulkAppState.productAssignments.clear();

            try {
                for (const productId of selectedProducts) {
                    const blueprint = await makeApiCall(`/catalog/blueprints/${productId}.json`);
                    const providers = await makeApiCall(`/catalog/blueprints/${productId}/print_providers.json`);
                    
                    if (providers.length === 0) {
                        console.warn(`No providers found for product ${productId}`);
                        continue;
                    }

                    // Auto-select first provider
                    const provider = providers[0];
                    const variants = await makeApiCall(`/catalog/blueprints/${productId}/print_providers/${provider.id}/variants.json`);
                    
                    if (!variants.variants || variants.variants.length === 0) {
                        console.warn(`No variants found for product ${productId} with provider ${provider.id}`);
                        continue;
                    }

                    // Extract print areas from variants
                    const printAreasMap = new Map();
                    variants.variants.forEach(variant => {
                        (variant.placeholders || []).forEach(p => {
                            if (!printAreasMap.has(p.position)) {
                                printAreasMap.set(p.position, {
                                    id: p.position,
                                    title: p.position.charAt(0).toUpperCase() + p.position.slice(1).replace('_', ' ')
                                });
                            }
                        });
                    });

                    BulkAppState.productAssignments.set(productId, {
                        blueprint: blueprint,
                        provider: provider,
                        variants: variants.variants,
                        printAreas: Array.from(printAreasMap.values()),
                        designAssignments: new Map()
                    });
                }

                console.log(`Loaded providers for ${selectedProducts.length} products`);
                showStep(4);
                
            } catch (error) {
                alert(`Error loading providers: ${error.message}`);
                console.error('Error loading providers:', error);
            } finally {
                statusDiv.remove();
            }
        }

        function handleProductSelection(checkbox) {
            const productId = checkbox.dataset.productId;
            const productCard = checkbox.closest('.product-card');
            
            if (checkbox.checked) {
                BulkAppState.selectedProducts.add(productId);
                productCard.classList.add('selected');
            } else {
                BulkAppState.selectedProducts.delete(productId);
                productCard.classList.remove('selected');
            }
            
            updateSelectedCount();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing bulk creator...');
            
            // Load saved API key
            const savedApiKey = localStorage.getItem('printifyApiKey');
            if (savedApiKey) {
                const apiKeyInput = document.getElementById('apiKey');
                if (apiKeyInput) apiKeyInput.value = savedApiKey;
                validateApiKey();
            }
            
            // --- SINGLE, PERMANENT LISTENER FOR STEP-2 CONTINUE BUTTON ---
            document.addEventListener('click', function (e) {
              if (e.target.id === 'selectShopBtn') {
                e.preventDefault();
                const shopId = document.getElementById('shopSelect').value;
                if (!shopId) { alert('Please select a shop.'); return; }

                const selectedShop = BulkAppState.shops.find(s => s.id == shopId);
                if (!selectedShop) { alert('Selected shop not found.'); return; }

                BulkAppState.selectedShop = selectedShop;
                loadBulkBlueprints();
                showStep(3);
              }
            });

            // Helper function to safely add event listeners
            function safeAddEventListener(elementId, event, handler) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener(event, handler);
                } else {
                    console.warn(`Element not found: ${elementId}`);
                }
            }

            // Step 1: API Setup
            safeAddEventListener('apiKey', 'input', validateApiKey);
            safeAddEventListener('verifyApiBtn', 'click', verifyApiKeyAndLoadShops);
            safeAddEventListener('apiKey', 'keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyApiKeyAndLoadShops();
                }
            });

            // Step 3: Product Selection
            safeAddEventListener('selectProductsBtn', 'click', () => {
                loadProvidersForSelectedProducts();
                showStep(4);
            });

            // Step 4: Design Generation
            safeAddEventListener('generateBulkDesignsBtn', 'click', generateBulkDesigns);
            safeAddEventListener('bulkUploadBtn', 'click', handleBulkImageUpload);
            safeAddEventListener('continueToAssignmentBtn', 'click', () => {
                showStep(5);
                buildAssignmentTable();
            });

            // Step 5: Print Area Assignment & Product Creation
            safeAddEventListener('generateAiContentBtn_step5', 'click', generateAiContentForProducts);
            safeAddEventListener('createBulkProductsBtn', 'click', createBulkProducts);

            console.log('Bulk creator initialized with full functionality');
        });

        // --- STEP 4: BULK DESIGN GENERATION ---
        async function generateBulkDesigns() {
            const prompt = document.getElementById('designPrompt').value.trim();
            const numDesigns = parseInt(document.getElementById('numDesigns').value);
            const model = document.getElementById('aiModel').value;
            
            if (!prompt) {
                alert('Please enter a design prompt.');
                return;
            }

            const statusDiv = document.getElementById('bulkGenerateStatus');
            const generateBtn = document.getElementById('generateBulkDesignsBtn');
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';

            try {
                const response = await fetch('https://transcendent-licorice-60df1e.netlify.app/.netlify/functions/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, numImages: numDesigns, model })
                });
                const result = await response.json();
                
                if (result.success && result.images) {
                    // Upload generated images to Printify (same as index.html)
                    const promises = [];
                    for (let i = 0; i < result.images.length; i++) {
                        const imgData = result.images[i];
                        promises.push(
                            makeApiCall('/uploads/images.json', {
                                method: 'POST',
                                body: { file_name: `${prompt.slice(0, 20)}_${i}.png`, url: imgData.url }
                            })
                        );
                    }
                    const uploadedImages = await Promise.all(promises);
                    uploadedImages.forEach(img => BulkAppState.generatedDesigns.push(img));
                    displayGeneratedDesigns();
                    statusDiv.innerHTML = `<div class="alert alert-success">Successfully generated and uploaded ${result.images.length} design(s) to Printify!</div>`;
                    document.getElementById('continueToAssignmentBtn').disabled = false;
                } else {
                    throw new Error(result.error || 'Generation failed');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="bi bi-stars"></i> Generate All Designs';
            }
        }

        // --- CLIENT-SIDE BACKGROUND REMOVAL HELPER ---
        async function removeBgClientSide(inputDataUrl) {
            // Dynamically load the library from CDN to avoid bundling
            // Try multiple CDNs to improve reliability
            let removeBackground;
            try {
                ({ removeBackground } = await import('https://cdn.skypack.dev/@imgly/background-removal'));
            } catch (e1) {
                try {
                    ({ removeBackground } = await import('https://esm.sh/@imgly/background-removal@2?bundle'));
                } catch (e2) {
                    ({ removeBackground } = await import('https://cdn.jsdelivr.net/npm/@imgly/background-removal@2/+esm'));
                }
            }
            // Convert input to Blob without violating CSP (no fetch for data: URLs)
            let inputBlob;
            if (typeof inputDataUrl === 'string' && inputDataUrl.startsWith('data:')) {
                const commaIdx = inputDataUrl.indexOf(',');
                const header = inputDataUrl.substring(0, commaIdx);
                const base64 = inputDataUrl.substring(commaIdx + 1);
                const mimeMatch = header.match(/^data:(.*?);base64$/i);
                const contentType = (mimeMatch && mimeMatch[1]) ? mimeMatch[1] : 'image/png';
                const byteChars = atob(base64);
                const byteNums = new Array(byteChars.length);
                for (let i = 0; i < byteChars.length; i++) byteNums[i] = byteChars.charCodeAt(i);
                const byteArray = new Uint8Array(byteNums);
                inputBlob = new Blob([byteArray], { type: contentType });
            } else {
                inputBlob = await (await fetch(inputDataUrl)).blob();
            }
            // Run background removal (returns a Blob - PNG with alpha)
            const outputBlob = await removeBackground(inputBlob);
            // Convert Blob back to Data URL for UI usage
            return await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(outputBlob);
            });
        }

        async function removeBackgroundFromDesign(designIndex) {
            const design = BulkAppState.generatedDesigns[designIndex];
            const statusDiv = document.getElementById('bulkGenerateStatus');
            const removeBgBtn = document.querySelector(`.design-card[data-design-index="${designIndex}"] .remove-bg-btn`);

            if (!design || !design.preview_url) {
                alert('Could not find the selected design or its image URL.');
                return;
            }

            removeBgBtn.disabled = true;
            removeBgBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Removing...';
            statusDiv.innerHTML = '<div class="text-info">Removing background...</div>';

            try {
                // Use proxy to fetch image to bypass CSP restrictions
                const imageResponse = await fetch('/.netlify/functions/fetch-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: design.preview_url })
                });
                
                if (!imageResponse.ok) {
                    throw new Error(`Failed to fetch image: ${imageResponse.status}`);
                }
                
                const blob = await imageResponse.blob();
                const dataUrl = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });

                // Run client-side background removal using IMG.LY
                const processedDataUrl = await removeBgClientSide(dataUrl);
                const designToUpdate = BulkAppState.generatedDesigns[designIndex];
                if (designToUpdate) {
                    // Update preview for UI immediately
                    designToUpdate.preview_url = processedDataUrl;
                    designToUpdate.source = `${design.source || 'Generated'} (BG Removed)`;

                    // Upload processed image to Printify to obtain a new image ID for final printing
                    try {
                        const base64 = processedDataUrl.split(',')[1];
                        if (base64) {
                            const uploaded = await makeApiCall('/uploads/images.json', {
                                method: 'POST',
                                body: { file_name: `bg-removed-${Date.now()}.png`, contents: base64 }
                            });
                            // Persist uploaded image metadata for creation API
                            if (uploaded && uploaded.id) {
                                designToUpdate.id = uploaded.id;
                            }
                            if (uploaded && uploaded.url) {
                                designToUpdate.url = uploaded.url;
                            }
                        }
                    } catch (e) {
                        console.warn('Failed to upload processed image to Printify; will attempt upload later during creation.', e);
                    }

                    displayGeneratedDesigns();
                }
                statusDiv.innerHTML = `<div class="alert alert-success">Background removed successfully!</div>`;
            } catch (error) {
                console.error('Error removing background:', error);
                statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                if (removeBgBtn) {
                    removeBgBtn.disabled = false;
                    removeBgBtn.innerHTML = '<i class="bi bi-eraser"></i> Remove BG';
                }
            }
        }

        // --- BACKGROUND REMOVAL FUNCTION ---
        async function removeBackgroundsFromDesigns() {
            if (BulkAppState.generatedDesigns.length === 0) {
                alert('No designs to process. Generate designs first.');
                return;
            }

            const removeBtn = document.getElementById('removeBackgroundsBtn');
            const statusDiv = document.getElementById('bulkGenerateStatus');
            
            removeBtn.disabled = true;
            removeBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Removing Backgrounds...';
            
            try {
                statusDiv.innerHTML = `<div class="alert alert-info">Processing ${BulkAppState.generatedDesigns.length} designs for background removal...</div>`;
                
                const processedDesigns = [];
                
                for (let i = 0; i < BulkAppState.generatedDesigns.length; i++) {
                    const design = BulkAppState.generatedDesigns[i];
                    statusDiv.innerHTML = `<div class="alert alert-info">Removing background from design ${i + 1}/${BulkAppState.generatedDesigns.length}...</div>`;
                    
                    try {
                        // Use proxy to fetch image to bypass CSP restrictions
                        const fetchResponse = await fetch('/.netlify/functions/fetch-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: design.preview_url })
                        });
                        
                        if (!fetchResponse.ok) {
                            throw new Error(`Failed to fetch image: ${fetchResponse.status}`);
                        }
                        
                        const blob = await fetchResponse.blob();
                        const dataUrl = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });

                        // Run client-side background removal using IMG.LY
                        const processedDataUrl = await removeBgClientSide(dataUrl);
                        processedDesigns.push({
                            ...design,
                            preview_url: processedDataUrl,
                            source: `${design.source || 'AI Generated'} (Background Removed)`
                        });
                    } catch (error) {
                        console.error('Error removing background from design', i, error);
                        processedDesigns.push(design); // Keep original if removal fails
                    }
                }
                
                BulkAppState.generatedDesigns = processedDesigns;
                displayGeneratedDesigns();
                statusDiv.innerHTML = `<div class="alert alert-success">Background removal completed! Processed ${processedDesigns.length} designs.</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error during background removal: ${error.message}</div>`;
            } finally {
                removeBtn.disabled = false;
                removeBtn.innerHTML = '<i class="bi bi-eraser"></i> Remove Backgrounds';
            }
        }

        function displayGeneratedDesigns() {
            const designsList = document.getElementById('bulkDesignsList');
            designsList.innerHTML = '';
            
            BulkAppState.generatedDesigns.forEach((design, index) => {
                // Handle both original AI images and uploaded Printify images
                const imageUrl = design.preview_url || design.url;
                const dataUrl = design.url || design.preview_url;
                
                const designCard = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card design-card" data-design-index="${index}" data-design-url="${dataUrl}">
                            <img src="${imageUrl}" class="card-img-top" alt="Generated design ${index + 1}" style="height: 200px; object-fit: cover;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkRlc2lnbjwvdGV4dD48L3N2Zz4=';">
                            <div class="card-body">
                                <small class="text-muted">${design.file_name ? 'Uploaded to Printify' : (design.source || 'AI Generated')}</small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-primary select-design-btn" onclick="selectDesign(${index})">
                                        <i class="bi bi-check-circle"></i> Select
                                    </button>
                                    ${design.preview_url ? `
                                        <button class="btn btn-sm btn-warning ms-1 remove-bg-btn" onclick="removeBackgroundFromDesign(${index})">
                                            <i class="bi bi-eraser"></i> Remove Background
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                designsList.innerHTML += designCard;
            });
        }

        function selectDesign(index) {
            BulkAppState.selectedDesign = BulkAppState.generatedDesigns[index];

            // Clear previous selections
            document.querySelectorAll('.design-card').forEach(card => {
                card.classList.remove('selected');
                card.style.border = '';
                const removeBgBtn = card.querySelector('.remove-bg-btn');
                if (removeBgBtn) removeBgBtn.style.display = 'none';
            });
            
            // Select current design
            const selectedCard = document.querySelector(`[data-design-index="${index}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                selectedCard.style.border = '3px solid #28a745';
                const removeBgBtn = selectedCard.querySelector('.remove-bg-btn');
                if (removeBgBtn) removeBgBtn.style.display = 'inline-block';
            }

            // Enable final creation button if a design is selected
            document.getElementById('createBulkProductsBtn').disabled = !BulkAppState.selectedDesign;
        }

        async function handleBulkImageUpload() {
            const fileInput = document.getElementById('bulkImageUpload');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) {
                alert('Please select images to upload.');
                return;
            }

            const statusDiv = document.getElementById('bulkGenerateStatus');
            const uploadBtn = document.getElementById('bulkUploadBtn');
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';

            try {
                const uploadPromises = files.map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => {
                            // Upload to Printify using the same method as index.html
                            makeApiCall('/uploads/images.json', { 
                                method: 'POST', 
                                body: { file_name: file.name, contents: reader.result.split(',')[1] }
                            }).then(resolve).catch(reject);
                        };
                        reader.onerror = reject;
                    });
                });

                const uploadedImages = await Promise.all(uploadPromises);
                BulkAppState.generatedDesigns.push(...uploadedImages);
                displayGeneratedDesigns();
                statusDiv.innerHTML = `<div class="alert alert-success">Successfully uploaded ${uploadedImages.length} image(s) to Printify!</div>`;
                document.getElementById('continueToAssignmentBtn').disabled = false;
                
                // Clear file input
                fileInput.value = '';
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error uploading images: ${error.message}</div>`;
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Upload Images';
            }
        }

        function downloadDesign(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- STEP 5: PRINT AREA ASSIGNMENT ---

        function selectPrintAreaForProduct(productId, areaId) {
            const assignment = BulkAppState.productAssignments.get(productId);
            if (assignment && assignment.printAreas) {
                const selectedArea = assignment.printAreas.find(area => area.id === areaId);
                if (selectedArea) {
                    assignment.selectedPrintArea = selectedArea;
                    console.log(`Selected print area ${selectedArea.title} for product ${productId}`);
                }
            }
        }

        function assignDesignToProduct(productId) {
            if (!BulkAppState.selectedDesign) {
                alert('Please select a design first.');
                return;
            }
            
            const assignment = BulkAppState.productAssignments.get(productId);
            if (assignment && assignment.selectedPrintArea) {
                // Store the design assignment
                if (!assignment.designAssignments) {
                    assignment.designAssignments = new Map();
                }
                assignment.designAssignments.set(assignment.selectedPrintArea.id, BulkAppState.selectedDesign);
                
                // Update button to show success
                const btn = document.querySelector(`[data-product-id="${productId}"].assign-design-btn`);
                if (btn) {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Assigned';
                }
                
                console.log(`Assigned design to ${assignment.selectedPrintArea.title} for product ${productId}`);
            } else {
                alert('Please select a print area first.');
            }
        }

        async function buildAssignmentTable() {
            const tableBody = document.getElementById('assignmentTableBody');
            tableBody.innerHTML = '<tr><td colspan="4"><div class="spinner-border"></div> Loading print areas...</td></tr>';
            
            try {
                const selectedProducts = Array.from(BulkAppState.selectedProducts);
                const productDetails = [];
                
                // Use existing print areas from productAssignments (already loaded in step 3)
                for (const productId of selectedProducts) {
                    const blueprint = BulkAppState.allBlueprints.find(bp => bp.id == productId);
                    if (!blueprint) continue;
                    
                    const assignment = BulkAppState.productAssignments.get(productId);
                    if (!assignment) {
                        console.warn(`No assignment found for product ${productId}`);
                        continue;
                    }
                    
                    // Use the print areas that were already loaded
                    let printAreas = assignment.printAreas || [];
                    
                    // Debug logging
                    console.log(`Product ${productId} (${blueprint.title}) has ${printAreas.length} print areas:`, printAreas.map(p => p.title));
                    
                    // If no print areas found, use a default (this shouldn't happen if step 3 worked correctly)
                    if (printAreas.length === 0) {
                        console.warn(`No print areas found for product ${productId}, using default`);
                        printAreas = [{ id: 'front', title: 'Front' }];
                    }
                    
                    productDetails.push({
                        productId,
                        title: blueprint.title,
                        image: blueprint.images[0],
                        printAreas: printAreas // Use all print areas, not just first 3
                    });
                }
                
                console.log('Product details for assignment table:', productDetails);
                displayAssignmentTable(productDetails);
                
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="4"><div class="alert alert-danger">Error loading print areas: ${error.message}</div></td></tr>`;
            }
        }

        function displayAssignmentTable(productDetails) {
            const tableBody = document.getElementById('assignmentTableBody');
            tableBody.innerHTML = '';
            
            productDetails.forEach(product => {
                const assignment = BulkAppState.productAssignments.get(product.productId);
                const printAreas = product.printAreas || [];
                const selectedPrintArea = assignment?.selectedPrintArea || (printAreas.length > 0 ? printAreas[0] : null);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${product.image}" alt="${product.title}" style="width: 40px; height: 40px; object-fit: cover; margin-right: 10px;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEMyMSAxOSAyMSAxOSAyMiAxOUMyMyAxOSAyMyAxOSAyNCAxOUMyNSAxOSAyNSAxOSAyNiAxOUMyNyAxOSAyNyAxOSAyOCAxOUMyOSAxOSAyOSAxOSAzMCAxOSIgc3Ryb2tlPSIjOUI5QjlCIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K'">
                            <div>
                                <strong>${product.title}</strong>
                            </div>
                        </div>
                    </td>
                    <td>
                        <select class="form-select form-select-sm print-area-select" data-product-id="${product.productId}">
                            ${printAreas.map(area => `
                                <option value="${area.id}" ${selectedPrintArea?.id === area.id ? 'selected' : ''}>
                                    ${area.title}
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <td>
                        ${BulkAppState.selectedDesign ? `
                            <div class="d-flex align-items-center">
                                <img src="${BulkAppState.selectedDesign.preview_url || BulkAppState.selectedDesign.url}" style="width: 30px; height: 30px; object-fit: cover; margin-right: 5px;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCAzMCAzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNSAxNUwxOCAxMkwyMSAxNUwxOCAxOEwxNSAxNVoiIGZpbGw9IiM5Qjk5OUIiLz4KPC9zdmc+Cg=='">
                                <small class="text-muted">Selected Design</small>
                            </div>
                        ` : '<small class="text-muted">No design selected</small>'}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners for print area selection
            document.querySelectorAll('.print-area-select').forEach(select => {
                select.addEventListener('change', function() {
                    const productId = this.dataset.productId;
                    const areaId = this.value;
                    selectPrintAreaForProduct(productId, areaId);
                });
            });
            
            
            document.getElementById('createBulkProductsBtn').disabled = !BulkAppState.selectedDesign;
        }

        function autoAssignDesigns(productId) {
            if (BulkAppState.generatedDesigns.length === 0) {
                alert('No designs available. Please generate or upload designs first.');
                return;
            }
            
            const randomDesign = BulkAppState.generatedDesigns[Math.floor(Math.random() * BulkAppState.generatedDesigns.length)];
            assignDesign(productId, randomDesign.url);
        }

        function autoAssignDesigns(productId) {
            if (BulkAppState.generatedDesigns.length === 0) {
                alert('No designs available. Please generate or upload designs first.');
                return;
            }
            
            const randomDesign = BulkAppState.generatedDesigns[Math.floor(Math.random() * BulkAppState.generatedDesigns.length)];
            assignDesign(productId, randomDesign.url);
        }

        // --- STEP 6: BULK PRODUCT CREATION ---
        function prepareBulkCreationSummary() {
            const selectedCount = BulkAppState.selectedProducts.size;
            const designCount = BulkAppState.generatedDesigns.length;
            
            document.getElementById('summaryProductCount').textContent = selectedCount;
            document.getElementById('summaryDesignCount').textContent = designCount;
            
            // Set default templates
            document.getElementById('bulkProductTitle').value = '{product_name} - Custom Design';
            document.getElementById('bulkProductDescription').value = 'High-quality custom design printed on premium {product_name}. Perfect for everyday wear with unique artwork.';
            document.getElementById('bulkProductTags').value = 'custom, unique, premium, design, art';
            
            updateBulkProductPreview();
        }

        async function generateAiContentForProducts(event) {
            const generateBtn = event.target.closest('button');
            const selectedDesign = BulkAppState.selectedDesign;
            
            if (!selectedDesign) {
                alert('Please select a design first.');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';

            try {
                const selectedProducts = Array.from(BulkAppState.selectedProducts);
                const aiContent = [];

                for (const productId of selectedProducts) {
                    const blueprint = BulkAppState.allBlueprints.find(bp => bp.id == productId);
                    if (!blueprint) continue;

                    const prompt = `Generate a compelling product title, description, and 5 relevant tags for a ${blueprint.title} with this design: ${selectedDesign.prompt || 'custom design'}. The product should appeal to modern consumers.`;

                    const response = await fetch('/.netlify/functions/generate-content', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            contentType: 'product-content'
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        aiContent.push({
                            productId,
                            title: result.title || `${blueprint.title} - Custom Design`,
                            description: result.description || `High-quality ${blueprint.title} with custom design.`,
                            tags: result.tags || ['custom', 'unique', 'premium']
                        });
                    } else {
                        aiContent.push({
                            productId,
                            title: `${blueprint.title} - Custom Design`,
                            description: `High-quality ${blueprint.title} with unique custom design.`,
                            tags: ['custom', 'unique', 'premium', 'design', 'art']
                        });
                    }
                }

                // Update UI with AI generated content
                aiContent.forEach(content => {
                    const product = BulkAppState.allBlueprints.find(bp => bp.id == content.productId);
                    if (product) {
                        product.aiTitle = content.title;
                        product.aiDescription = content.description;
                        product.aiTags = Array.isArray(content.tags) ? content.tags.join(', ') : content.tags;
                    }
                });

                updateBulkProductPreview();
                
                // Update form fields with first product's content as template
                if (aiContent.length > 0) {
                    document.getElementById('bulkProductTitle').value = aiContent[0].title;
                    document.getElementById('bulkProductDescription').value = aiContent[0].description;
                    document.getElementById('bulkProductTags').value = aiContent[0].tags;
                }

                alert(`AI content generated for ${aiContent.length} products!`);

            } catch (error) {
                console.error('Error generating AI content:', error);
                alert('Error generating AI content. Please try again.');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="bi bi-robot"></i> Generate AI Content';
            }
        }

        function updateBulkProductPreview() {
            const previewDiv = document.getElementById('bulkProductPreview');
            const selectedProducts = Array.from(BulkAppState.selectedProducts);
            
            if (selectedProducts.length === 0) {
                previewDiv.innerHTML = '<p class="text-muted">No products selected</p>';
                return;
            }
            
            let previewHtml = '<div class="row">';
            
            selectedProducts.slice(0, 6).forEach(productId => {
                const blueprint = BulkAppState.allBlueprints.find(bp => bp.id == productId);
                if (!blueprint) return;

                const assignment = BulkAppState.productAssignments.get(productId);
                const printAreas = assignment?.printAreas || [{id: 'front', title: 'Front'}];
                const selectedDesign = BulkAppState.selectedDesign;
                const titleTemplate = document.getElementById('bulkProductTitle').value || '{product_name} - Custom Design';
                const generatedTitle = titleTemplate.replace(/{product_name}/g, blueprint.title);

                previewHtml += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <img src="${blueprint.images[0]}" class="card-img-top" alt="${blueprint.title}" style="height: 120px; object-fit: cover;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik02MCA2MEw2NSA1NUw3MCA2MEw2NSA2NUw2MCA2MFoiIGZpbGw9IiM5Qjk5OUIiLz4KPC9zdmc+Cg=='">
                            <div class="card-body p-2">
                                <h6 class="card-title" style="font-size: 0.85rem;">${generatedTitle}</h6>
                                <small class="text-muted d-block">${printAreas.map(area => area.title).join(', ')}</small>
                                ${selectedDesign ? `
                                    <div class="mt-2 d-flex align-items-center">
                                        <img src="${selectedDesign.preview_url || selectedDesign.url}" style="width: 20px; height: 20px; object-fit: cover; margin-right: 5px;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xMCAxMEwxMiA4TDE0IDEwTDEyIDEyTDEwIDEwWiIgZmlsbD0iIzlCOTk5QiIvPgo8L3N2Zz4K'">
                                        <small class="text-success">Design assigned</small>
                                    </div>
                                ` : '<small class="text-warning">No design</small>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (selectedProducts.length > 6) {
                previewHtml += `
                    <div class="col-12">
                        <small class="text-muted">... and ${selectedProducts.length - 6} more products</small>
                    </div>
                `;
            }
            
            previewHtml += '</div>';
            previewDiv.innerHTML = previewHtml;
        }

        async function createBulkProducts() {
            const titleTemplate = document.getElementById('bulkProductTitle').value.trim();
            const descriptionTemplate = document.getElementById('bulkProductDescription').value.trim();
            const tags = document.getElementById('bulkProductTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            if (!titleTemplate || !descriptionTemplate) {
                alert('Please fill in product title and description templates.');
                return;
            }

            if (!BulkAppState.selectedDesign) {
                alert('Please select a design first.');
                return;
            }

            const createBtn = document.getElementById('createBulkProductsBtn');
            const statusDiv = document.createElement('div');
            statusDiv.className = 'mt-3';
            createBtn.parentNode.insertBefore(statusDiv, createBtn.nextSibling);

            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating Products...';

            const selectedProducts = Array.from(BulkAppState.selectedProducts);
            const createdProducts = [];
            let successCount = 0;
            let errorCount = 0;

            try {
                statusDiv.innerHTML = `<div class="alert alert-info">Creating ${selectedProducts.length} products...</div>`;

                for (const productId of selectedProducts) {
                    const blueprint = BulkAppState.allBlueprints.find(bp => bp.id == productId);
                    if (!blueprint) continue;

                    const assignment = BulkAppState.productAssignments.get(productId);
                    if (!assignment) continue;

                    try {
                        // Generate product title and description from templates
                        const productTitle = titleTemplate.replace(/{product_name}/g, blueprint.title);
                        const productDescription = descriptionTemplate.replace(/{product_name}/g, blueprint.title);

                        // Prepare variants for API - match index.html structure
                        const variantsForApi = [];
                        assignment.variants.forEach(variant => {
                            variantsForApi.push({
                                id: variant.id,
                                price: variant.price || 1000 // Use existing price or default to $10.00 (1000 cents)
                            });
                        });

                        // Prepare print areas for API - match index.html structure
                        const printAreasForApi = [];
                        const selectedPrintArea = assignment.selectedPrintArea || (assignment.printAreas && assignment.printAreas[0]);
                        const selectedDesign = BulkAppState.selectedDesign;

                        // Safeguard: if the selected design is a data URL (background-removed preview) and lacks an uploaded id, upload it now
                        if (selectedDesign && !selectedDesign.id && selectedDesign.preview_url && selectedDesign.preview_url.startsWith('data:')) {
                            try {
                                const base64 = selectedDesign.preview_url.split(',')[1];
                                if (base64) {
                                    const uploadedNow = await makeApiCall('/uploads/images.json', {
                                        method: 'POST',
                                        body: { file_name: `bg-removed-${Date.now()}.png`, contents: base64 }
                                    });
                                    if (uploadedNow && uploadedNow.id) selectedDesign.id = uploadedNow.id;
                                    if (uploadedNow && uploadedNow.url) selectedDesign.url = uploadedNow.url;
                                }
                            } catch (e) {
                                console.warn('On-the-fly upload of processed image failed:', e);
                            }
                        }

                        if (selectedPrintArea && selectedDesign) {
                            printAreasForApi.push({
                                variant_ids: assignment.variants.map(v => v.id),
                                placeholders: [{
                                    position: selectedPrintArea.id,
                                    images: [{
                                        id: selectedDesign.id,
                                        x: 0.5,
                                        y: 0.5,
                                        scale: 1,
                                        angle: 0
                                    }]
                                }]
                            });
                        }

                        // Create product data - match index.html structure exactly
                        const productData = {
                            title: productTitle,
                            description: productDescription,
                            blueprint_id: parseInt(productId),
                            print_provider_id: assignment.provider.id,
                            variants: variantsForApi,
                            print_areas: printAreasForApi
                        };

                        // Add tags if provided
                        if (tags.length > 0) {
                            productData.tags = tags;
                        }

                        console.log(`Creating product: ${productTitle}`, productData);

                        // Create the product using the same API call as index.html
                        const result = await makeApiCall(`/shops/${BulkAppState.selectedShop.id}/products.json`, {
                            method: 'POST',
                            body: productData
                        });

                        successCount++;
                        createdProducts.push({
                            productId: result.id,
                            title: productTitle,
                            status: 'success'
                        });

                        console.log(`Successfully created product: ${productTitle} (ID: ${result.id})`);

                    } catch (error) {
                        errorCount++;
                        createdProducts.push({
                            productId: null,
                            title: blueprint.title,
                            status: 'error',
                            error: error.message
                        });
                        
                        console.error(`Error creating product ${blueprint.title}:`, error);
                    }
                }

                // Display final results
                const totalProducts = selectedProducts.length;
                const summaryHtml = `
                    <div class="alert ${successCount === totalProducts ? 'alert-success' : 'alert-warning'}">
                        <h5>Bulk Creation Complete!</h5>
                        <p><strong>Total Products:</strong> ${totalProducts}</p>
                        <p><strong>Successfully Created:</strong> ${successCount}</p>
                        ${errorCount > 0 ? `<p><strong>Errors:</strong> ${errorCount}</p>` : ''}
                        ${successCount > 0 ? `
                        <div class="mt-2">
                            <a href="pricing.html" class="btn btn-outline-primary">
                                <i class="bi bi-currency-dollar"></i> Manage Pricing
                            </a>
                        </div>` : ''}
                    </div>
                `;

                statusDiv.innerHTML = summaryHtml;

                if (successCount > 0) {
                    // Show created products list
                    const productsList = createdProducts
                        .filter(p => p.status === 'success')
                        .map(p => `<li>${p.title}</li>`)
                        .join('');
                    
                    statusDiv.innerHTML += `
                        <div class="alert alert-info">
                            <h6>Created Products:</h6>
                            <ul>${productsList}</ul>
                        </div>
                    `;
                }

                if (errorCount > 0) {
                    // Show error details
                    const errorsList = createdProducts
                        .filter(p => p.status === 'error')
                        .map(p => `<li>${p.title}: ${p.error}</li>`)
                        .join('');
                    
                    statusDiv.innerHTML += `
                        <div class="alert alert-danger">
                            <h6>Errors:</h6>
                            <ul>${errorsList}</ul>
                        </div>
                    `;
                }

                if (successCount === totalProducts) {
                    alert(`All ${successCount} products created successfully!`);
                } else if (successCount > 0) {
                    alert(`Created ${successCount} out of ${totalProducts} products. Check details above.`);
                } else {
                    alert('No products were created. Please check the errors above.');
                }

            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error during bulk creation: ${error.message}</div>`;
                console.error('Bulk creation error:', error);
                alert(`Error during bulk creation: ${error.message}`);
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Create All Products';
            }
        }

        // Print provider selection functions
        async function loadBlueprintDetails(blueprintId) {
            const providerSelect = document.getElementById('bulkProviderSelect');
            providerSelect.innerHTML = '<option>Loading details...</option>';
            providerSelect.disabled = true;
            document.getElementById('bulkPrintAreasContainer').style.display = 'none';
            document.getElementById('selectProductBtn').disabled = true;
            
            try {
                const blueprint = await makeApiCall(`/catalog/blueprints/${blueprintId}.json`);
                const providers = await makeApiCall(`/catalog/blueprints/${blueprintId}/print_providers.json`);
                BulkAppState.selectedBlueprint = blueprint;
                
                providerSelect.innerHTML = '<option value="">-- Select a Provider --</option>';
                providers.forEach(p => {
                    providerSelect.innerHTML += `<option value="${p.id}">${p.title}</option>`;
                });
                providerSelect.disabled = false;
            } catch (error) {
                providerSelect.innerHTML = '<option>Error loading details</option>';
                alert(`Error loading blueprint details: ${error.message}`);
            }
        }

        async function onProviderChange(providerId) {
            document.getElementById('bulkPrintAreasContainer').style.display = 'none';
            document.getElementById('selectProductBtn').disabled = true;
            if (!providerId) return;

            BulkAppState.selectedProvider = { id: parseInt(providerId, 10) };
            const blueprintId = BulkAppState.selectedBlueprint.id;
            const printAreasList = document.getElementById('bulkPrintAreasList');
            printAreasList.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Loading variants...';

            try {
                const data = await makeApiCall(`/catalog/blueprints/${blueprintId}/print_providers/${providerId}/variants.json`);
                if (!data.variants || data.variants.length === 0) throw new Error('No variants found for this provider.');

                BulkAppState.variants = data.variants;
                const printAreasMap = new Map();
                data.variants.forEach(variant => {
                    (variant.placeholders || []).forEach(p => {
                        if (!printAreasMap.has(p.position)) {
                            printAreasMap.set(p.position, { 
                                id: p.position, 
                                title: p.position.charAt(0).toUpperCase() + p.position.slice(1).replace('_', ' ')
                            });
                        }
                    });
                });
                BulkAppState.printAreas = Array.from(printAreasMap.values());

                printAreasList.innerHTML = '';
                BulkAppState.printAreas.forEach(area => {
                    printAreasList.innerHTML += `<div class="col-12 mb-2"><div class="p-3 border rounded bg-light">${area.title}</div></div>`;
                });

                document.getElementById('bulkPrintAreasContainer').style.display = 'block';
                document.getElementById('selectProductBtn').disabled = false;
            } catch (error) {
                printAreasList.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                alert(`Failed to load provider data: ${error.message}`);
            }
        }

        // Load shops function
        async function loadShops() {
            try {
                const apiKey = localStorage.getItem('printify_api_key');
                if (!apiKey) {
                    showError('Please enter your API key first');
                    return;
                }

                const response = await fetch('https://api.printify.com/v1/shops.json', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load shops');
                }

                const shops = await response.json();
                const shopSelect = document.getElementById('shopSelect');
                
                shopSelect.innerHTML = '<option value="">-- Select a Shop --</option>';
                shops.forEach(shop => {
                    const option = document.createElement('option');
                    option.value = shop.id;
                    option.textContent = shop.title;
                    shopSelect.appendChild(option);
                });

                // Re-enable select
                shopSelect.disabled = false;
                document.getElementById('selectShopBtn').disabled = false;
                
            } catch (error) {
                showError('Error loading shops: ' + error.message);
            }
        }

    </script>
</body>
</html>
