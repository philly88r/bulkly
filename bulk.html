<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printify Bulk Product Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js" integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin="anonymous" referrerpolicy="no-referrer" async=""></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-600: #0284c7;
            --secondary: #14b8a6;
            --success: #22c55e;
            --surface: #ffffff;
            --muted: #64748b;
            --radius: 12px;
            --shadow: 0 8px 24px rgba(2, 6, 23, 0.06);
        }

        body {
            background: linear-gradient(180deg, #f8fafc, #ffffff 50%);
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            color: #0f172a;
        }

        .step-container {
            display: none;
        }
        .step-container.active {
            display: block;
        }

        .navbar {
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.06);
        }
        .navbar.navbar-dark.bg-dark {
            background: linear-gradient(135deg, #0b1220, #0f172a 40%, #0b3a4c) !important;
        }
        .navbar .nav-link:hover, .navbar .navbar-brand:hover {
            color: #bae6fd !important;
        }

        .card {
            border: 1px solid #e5e7eb;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-600));
            border: none;
        }
        .btn-primary:hover {
            filter: brightness(0.98);
            transform: translateY(-1px);
        }
        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 .14rem rgba(14, 165, 233, .28);
        }

        .step-indicator { 
            gap: 12px; 
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .step-indicator .step {
            background: #f1f5f9;
            border-radius: var(--radius);
            border: 1px solid #e2e8f0;
            padding: 14px;
            transition: all .2s ease;
            text-align: center;
            min-width: 120px;
        }
        .step-indicator .step.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-600));
            color: #fff;
            box-shadow: 0 8px 18px rgba(2, 132, 199, .25);
        }
        .step-indicator .step.completed {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
        }

        .loading-spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1, h4, h5 { 
            letter-spacing: -0.015em; 
        }
        h1 { 
            font-weight: 700; 
        }
        h4, h5 { 
            font-weight: 600; 
            color: #0f172a; 
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="index.html">Printify Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Create Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="bulk.html">Bulk Creator</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="pricing.html">Manage Pricing</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="inspiration.html">Search Inspiration</a>
                    </li>
                </ul>
                <div class="navbar-nav ms-auto">
                    <span class="navbar-text me-3" id="userGreeting">Welcome!</span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4"><i class="bi bi-layers"></i> Bulk Product Creator</h1>
        
        <!-- Step Indicator -->
        <div class="step-indicator mb-4">
            <div class="step active" id="step-indicator-1">
                <i class="bi bi-shop"></i><br>
                <small>1. Shop</small>
            </div>
            <div class="step" id="step-indicator-2">
                <i class="bi bi-check-square"></i><br>
                <small>2. Products</small>
            </div>
            <div class="step" id="step-indicator-3">
                <i class="bi bi-palette"></i><br>
                <small>3. Assign Designs</small>
            </div>
            <div class="step" id="step-indicator-4">
                <i class="bi bi-magic"></i><br>
                <small>4. Generate</small>
            </div>
            <div class="step" id="step-indicator-5">
                <i class="bi bi-check-circle"></i><br>
                <small>5. Create</small>
            </div>
        </div>

        <!-- Step 1: Shop Selection -->
        <div class="step-container active" id="step1-container">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-shop"></i> Step 1: Select Shop</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="shopSelect" class="form-label">Choose your Printify shop</label>
                        <select class="form-select" id="shopSelect">
                            <option value="">Loading shops...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="selectShopBtn" disabled>
                        <i class="bi bi-arrow-right"></i> Continue to Product Selection
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Product Selection -->
        <div class="step-container" id="step2-container">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-box"></i> Select Products</h4>
                </div>
                <div class="card-body">
                    <div id="productsGrid" class="row">
                        <!-- Products will be loaded here -->
                    </div>
                    
                    <div class="mt-3">
                        <p><strong>Selected:</strong> <span id="selectedCount">0</span> products</p>
                        <button class="btn btn-primary" id="selectProductsBtn" disabled>
                            <i class="bi bi-arrow-right"></i> Continue to Design
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Design Assignment -->
        <div class="step-container" id="step3-container">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-palette"></i> Step 3: Assign Designs & Print Areas</h4>
                </div>
                <div class="card-body">
                    <div id="step3-content">
                        <!-- Product table will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Generate Products -->
        <div class="step-container" id="step4-container">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-magic"></i> Step 4: Generate Products</h4>
                </div>
                <div class="card-body">
                    <div id="step4-content">
                        <!-- Generation interface will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state for bulk operations
        const BulkAppState = {
            selectedShop: null,
            selectedProducts: new Set(),
            allBlueprints: [],
            shops: []
        };

        // Utility functions
        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = 'auth.html';
        }

        // --- JWT Token-based Authentication (matching index.html) ---
        async function initializeBulkApp() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/auth.html';
                return;
            }

            try {
                // Check if API key is saved in database
                const response = await fetch('/.netlify/functions/get-api-key', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.apiKey) {
                    // API key found, proceed to load shops
                    BulkAppState.apiKey = data.apiKey;
                    
                    // Load shops using the API key from database
                    await loadShopsFromDatabase(data.apiKey);
                } else {
                    // No API key found
                    showError('Please set up your Printify API key in your dashboard settings first.');
                }
            } catch (error) {
                console.error('Error initializing bulk app:', error);
                showError('Authentication error: ' + error.message);
            }
        }

        async function loadShopsFromDatabase(apiKey) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/.netlify/functions/printify-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        endpoint: '/v1/shops.json',
                        method: 'GET'
                    })
                });

                const data = await response.json();
                
                if (data.success && data.data) {
                    const shops = data.data;
                    if (shops.length > 0) {
                        BulkAppState.shops = shops;
                        populateShops(shops);
                    } else {
                        showError('No shops found. Please check your Printify account.');
                    }
                } else {
                    showError('Error loading shops. Please check your API key in dashboard settings.');
                }
            } catch (error) {
                showError('Error connecting to Printify API');
            }
        }

        function populateShops(shops) {
            const shopSelect = document.getElementById('shopSelect');
            shopSelect.innerHTML = '<option value="">-- Select a Shop --</option>';
            shops.forEach(shop => {
                shopSelect.innerHTML += `<option value="${shop.id}">${shop.title}</option>`;
            });
            
            // Enable shop selection
            shopSelect.disabled = false;
            
            // Handle shop selection change
            shopSelect.addEventListener('change', function() {
                if (this.value) {
                    BulkAppState.selectedShop = this.value;
                    document.getElementById('selectShopBtn').disabled = false;
                } else {
                    document.getElementById('selectShopBtn').disabled = true;
                }
            });

            // Handle continue button click
            document.getElementById('selectShopBtn').addEventListener('click', function() {
                if (BulkAppState.selectedShop) {
                    proceedToStep2();
                }
            });
        }

        function proceedToStep2() {
            // Hide step 1, show step 2
            document.getElementById('step1-container').classList.remove('active');
            document.getElementById('step2-container').classList.add('active');
            
            // Update step indicator
            document.getElementById('step-indicator-1').classList.remove('active');
            document.getElementById('step-indicator-1').classList.add('completed');
            document.getElementById('step-indicator-2').classList.add('active');
            
            // Load products for the selected shop
            loadProductsForShop();
        }

        async function loadProductsForShop() {
            console.log('Loading products for shop:', BulkAppState.selectedShop);
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/.netlify/functions/printify-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        endpoint: `/v1/catalog/blueprints.json`,
                        method: 'GET'
                    })
                });

                const data = await response.json();
                console.log('Products response:', data);
                
                if (data.success && data.data) {
                    // Handle paginated response format
                    const products = Array.isArray(data.data) ? data.data : data.data.data || [];
                    populateProducts(products);
                } else {
                    populateProducts([]);
                    showNotification('No products found for this shop', 'info');
                }
            } catch (error) {
                showError('Error connecting to Printify API');
                console.error('Error:', error);
            }
        }

        // Pagination state
        let currentPage = 1;
        const productsPerPage = 12;
        let allProducts = [];

        function populateProducts(products) {
            // Ensure each product has a blueprint_id
            allProducts = products.map(product => ({
                ...product,
                // Use the product's id as blueprint_id if not already present
                blueprint_id: product.blueprint_id || product.id
            }));
            currentPage = 1;
            renderProductsPage();
        }

        function updateSelectedCount() {
            const count = BulkAppState.selectedProducts.size;
            document.getElementById('selectedCount').textContent = count;
            
            const continueBtn = document.getElementById('selectProductsBtn');
            continueBtn.disabled = count === 0;
            
            // Update button text based on selection
            if (count > 0) {
                continueBtn.innerHTML = `<i class="bi bi-arrow-right"></i> Continue with ${count} product${count === 1 ? '' : 's'}`;
            } else {
                continueBtn.innerHTML = '<i class="bi bi-arrow-right"></i> Continue to Design';
            }
        }

        function renderProductsPage() {
            const productsGrid = document.getElementById('productsGrid');
            const startIndex = (currentPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const pageProducts = allProducts.slice(startIndex, endIndex);
            
            productsGrid.innerHTML = '';
            
            if (allProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="text-muted">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <h5>No products found</h5>
                            <p>Try selecting a different shop or check your connection.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            pageProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'col-lg-3 col-md-4 col-sm-6 mb-4';
                
                // Get the first image or use a placeholder
                const imageUrl = product.images && product.images.length > 0 
                    ? product.images[0] 
                    : 'https://via.placeholder.com/300x300?text=No+Image';
                
                productCard.innerHTML = `
                    <div class="card h-100 shadow-sm product-card" style="transition: all 0.3s ease; border: none; border-radius: 12px;">
                        <div class="position-relative overflow-hidden" style="border-radius: 12px 12px 0 0;">
                            <img src="${imageUrl}" class="card-img-top" alt="${product.title}" 
                                 style="height: 200px; object-fit: cover; transition: transform 0.3s ease;"
                                 onmouseover="this.style.transform='scale(1.05)'"
                                 onmouseout="this.style.transform='scale(1)'">
                            <div class="position-absolute top-0 end-0 p-2">
                                <div class="form-check">
                                    <input class="form-check-input product-checkbox" type="checkbox" 
                                           value="${product.id}" id="product-${product.id}"
                                           style="transform: scale(1.2);">
                                </div>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary small">${product.brand || 'Printify'}</span>
                            </div>
                            <h6 class="card-title fw-bold mb-2" style="color: #2c3e50; line-height: 1.3;">
                                ${product.title || 'Untitled Product'}
                            </h6>
                            <p class="card-text text-muted small mb-3 flex-grow-1" style="line-height: 1.4;">
                                ${product.description ? (product.description.length > 80 ? product.description.substring(0, 80) + '...' : product.description) : 'Premium quality product ready for customization'}
                            </p>
                            <div class="d-flex justify-content-between align-items-center mt-auto">
                                <small class="text-muted">ID: ${product.id}</small>
                                <button class="btn btn-outline-primary btn-sm" onclick="selectProduct(${product.id})" style="border-radius: 20px;">
                                    <i class="fas fa-plus me-1"></i>Select
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
            
            // Add pagination controls
            renderPagination();
            
            // Add event listeners for checkboxes and restore selection state
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                // Ensure consistent string comparison for product IDs
                const productId = String(checkbox.value);
                checkbox.checked = BulkAppState.selectedProducts.has(productId);
                checkbox.addEventListener('change', function() {
                    const id = String(this.value);
                    if (this.checked) {
                        BulkAppState.selectedProducts.add(id);
                    } else {
                        BulkAppState.selectedProducts.delete(id);
                    }
                    updateSelectedCount();
                });
            });
            
            // Add hover effects
            document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                });
            });
        }

        function renderPagination() {
            const totalPages = Math.ceil(allProducts.length / productsPerPage);
            const paginationContainer = document.getElementById('paginationContainer') || createPaginationContainer();
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'block';
            
            let paginationHTML = `
                <nav aria-label="Product pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" style="border-radius: 8px 0 0 8px;">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
            `;
            
            // Show page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }
            
            paginationHTML += `
                        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" style="border-radius: 0 8px 8px 0;">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        Showing ${((currentPage - 1) * productsPerPage) + 1}-${Math.min(currentPage * productsPerPage, allProducts.length)} of ${allProducts.length} products
                    </small>
                </div>
            `;
            
            paginationContainer.innerHTML = paginationHTML;
        }

        function createPaginationContainer() {
            const container = document.createElement('div');
            container.id = 'paginationContainer';
            container.className = 'mt-4';
            document.getElementById('productsGrid').parentNode.appendChild(container);
            return container;
        }

        function changePage(page) {
            const totalPages = Math.ceil(allProducts.length / productsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderProductsPage();
                // Scroll to top of products
                document.getElementById('productsGrid').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function selectProduct(productId) {
            const checkbox = document.getElementById(`product-${productId}`);
            checkbox.checked = !checkbox.checked;
            updateSelectedCount();
        }

        // Load shops on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeBulkApp();
            
            // Add event listener for continue button
            document.getElementById('selectProductsBtn').addEventListener('click', function() {
                if (BulkAppState.selectedProducts.size > 0) {
                    proceedToStep3();
                }
            });
        });
        
        function proceedToStep3() {
            // Get complete product data for selected products
            const selectedProductsData = allProducts.filter(p => 
                BulkAppState.selectedProducts.has(p.id.toString())
            );
            
            // Store selected products in session storage for next step
            sessionStorage.setItem('bulkSelectedProducts', JSON.stringify(selectedProductsData.map(p => p.id)));
            sessionStorage.setItem('bulkSelectedShop', BulkAppState.selectedShop);
            
            // Navigate to the next step (step 3: design assignment)
            document.getElementById('step2-container').classList.remove('active');
            document.getElementById('step3-container').classList.add('active');
            
            // Update step indicator
            document.getElementById('step-indicator-2').classList.remove('active');
            document.getElementById('step-indicator-2').classList.add('completed');
            document.getElementById('step-indicator-3').classList.add('active');
            
            // Populate step 3 with selected products
            populateStep3(selectedProductsData);
        }
        
        async function populateStep3(selectedProducts) {
            const step3Content = document.getElementById('step3-content');
            if (!step3Content) {
                console.error('Step 3 content element not found');
                return;
            }
            
            if (!Array.isArray(selectedProducts) || selectedProducts.length === 0) {
                console.error('No products selected or invalid product data');
                step3Content.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No products selected or invalid product data. Please go back and try again.
                    </div>
                `;
                return;
            }
            
            // Show loading state
            step3Content.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading print areas...</span>
                    </div>
                    <p class="text-muted">Loading print areas for ${selectedProducts.length} product${selectedProducts.length === 1 ? '' : 's'}...</p>
                </div>
            `;
            
            try {
                // Process the selected products
                const printAreaData = {};
                
                for (const product of selectedProducts) {
                    if (!product || !product.blueprint_id) {
                        console.warn('Skipping product with missing blueprint_id:', product);
                        continue;
                    }
                    
                    try {
                        console.log('Fetching print areas for product:', product.id, 'Blueprint ID:', product.blueprint_id);
                        const areas = await fetchProductPrintAreas(product);
                        printAreaData[product.id] = areas;
                    } catch (error) {
                        console.error(`Error fetching print areas for product ${product.id}:`, error);
                        // Use default print areas if there's an error
                        printAreaData[product.id] = [
                            {
                                id: 'front',
                                name: 'Front',
                                dimensions: '3000×3000px (10×10")',
                                width: 3000,
                                height: 3000,
                                icon: 'bi-square'
                            },
                            {
                                id: 'back',
                                name: 'Back',
                                dimensions: '3000×3000px (10×10")',
                                width: 3000,
                                height: 3000,
                                icon: 'bi-square'
                            }
                        ];
                    }
                }
                
                let html = `
                    <div class="mb-4">
                        <p class="lead">Configure designs and print areas for your <strong>${selectedProducts.length} selected product${selectedProducts.length === 1 ? '' : 's'}</strong></p>
                        <p class="text-muted small">Actual dimensions loaded from Printify API</p>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" style="border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                            <thead class="table-dark" style="background: linear-gradient(135deg, #0f172a, #1e293b);">
                                <tr>
                                    <th scope="col" style="padding: 1rem; font-weight: 600;">Product</th>
                                    <th scope="col" style="padding: 1rem; font-weight: 600;">Print Areas (Max 2)</th>
                                    <th scope="col" style="padding: 1rem; font-weight: 600;">Preview</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${selectedProducts.map((product, index) => {
                                    const areas = printAreaData[product.id] || [];
                                    return `
                                        <tr style="border: none; background: ${index % 2 === 0 ? '#ffffff' : '#f8fafc'};">
                                            <td style="padding: 1.5rem 1rem;">
                                                <div class="d-flex align-items-center">
                                                    <div class="product-image-container me-3" style="width: 80px; height: 80px; border-radius: 12px; overflow: hidden; border: 2px solid #e5e7eb; background: #f8fafc;">
                                                        <img src="${product.images && product.images[0] ? product.images[0] : 'https://via.placeholder.com/80x80/e5e7eb/64748b?text=No+Image'}" 
                                                             alt="${product.title}" 
                                                             class="img-fluid" 
                                                             style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;"
                                                             onmouseover="this.style.transform='scale(1.1)'" 
                                                             onmouseout="this.style.transform='scale(1)'">
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-1 fw-bold" style="color: #1e293b; font-size: 0.95rem;">${product.title}</h6>
                                                        <p class="mb-0 text-muted small">ID: ${product.id}</p>
                                                        <span class="badge bg-primary bg-opacity-10 text-primary small">${product.brand || 'Printify'}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td style="padding: 1.5rem 1rem;">
                                                <div class="print-areas-container" data-product-id="${product.id}">
                                                    ${areas.map(area => `
                                                        <div class="form-check form-check-inline mb-2">
                                                            <input class="form-check-input print-area-checkbox" 
                                                                   type="checkbox" 
                                                                   id="area-${product.id}-${area.id}" 
                                                                   value="${area.id}"
                                                                   data-product-id="${product.id}"
                                                                   onchange="limitPrintAreas(this)"
                                                                   style="transform: scale(1.1);">
                                                            <label class="form-check-label small fw-medium" for="area-${product.id}-${area.id}" style="color: #374151;">
                                                                <i class="bi ${area.icon} me-1"></i>${area.name} 
                                                                <span class="text-muted">(${area.dimensions})</span>
                                                            </label>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </td>
                                            <td style="padding: 1.5rem 1rem;">
                                                <div class="preview-container" data-product-id="${product.id}">
                                                    <div class="preview-placeholder d-flex align-items-center justify-content-center" 
                                                         style="width: 60px; height: 60px; border-radius: 8px; background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border: 2px dashed #cbd5e1;">
                                                        <i class="bi bi-eye text-muted"></i>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Select up to 2 print areas per product
                        </div>
                        <button class="btn btn-primary btn-lg" onclick="proceedToStep4()" style="border-radius: 25px; padding: 0.75rem 2rem;">
                            <i class="bi bi-arrow-right me-2"></i>Continue to Generate
                        </button>
                    </div>
                `;
                
                step3Content.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading print areas:', error);
                step3Content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading print areas: ${error.message}
                        <br><br>
                        <button class="btn btn-outline-primary" onclick="populateStep3()">Retry</button>
                    </div>
                `;
            }
        }
        
        async function fetchProductPrintAreas(product) {
            try {
                if (!product || !product.blueprint_id) {
                    throw new Error('Invalid product data: missing blueprint_id');
                }

                // Use the proxy endpoint to avoid CORS issues
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('Authentication required. Please log in again.');
                }

                // First, get print providers for this blueprint
                const printProvidersResponse = await fetch('/.netlify/functions/printify-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        endpoint: `/v1/catalog/blueprints/${product.blueprint_id}/print_providers.json`,
                        method: 'GET'
                    })
                });
                
                if (!printProvidersResponse.ok) {
                    const error = await printProvidersResponse.text();
                    throw new Error(`Failed to fetch print providers: ${printProvidersResponse.status} ${error}`);
                }
                
                const result = await printProvidersResponse.json();
                const printProviders = result.data;
                
                if (!printProviders || printProviders.length === 0) {
                    throw new Error('No print providers found for this product');
                }
                
                // Get variants for the first print provider
                const printProviderId = printProviders[0].id;
                const variantsResponse = await fetch('/.netlify/functions/printify-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        endpoint: `/v1/catalog/blueprints/${product.blueprint_id}/print_providers/${printProviderId}/variants.json`,
                        method: 'GET'
                    })
                });
                
                if (!variantsResponse.ok) {
                    const error = await variantsResponse.text();
                    throw new Error(`Failed to fetch variants: ${variantsResponse.status} ${error}`);
                }
                
                const variantsResult = await variantsResponse.json();
                const variants = variantsResult.data;
                
                if (!variants || variants.length === 0) {
                    throw new Error('No variants found for this product');
                }
                
                // Extract print areas from the first variant
                const firstVariant = variants[0];
                const placeholders = firstVariant.placeholders || [];
                
                // Convert placeholders to print area format
                return placeholders.map((placeholder, index) => {
                    const widthInches = (placeholder.width / 300).toFixed(1);
                    const heightInches = (placeholder.height / 300).toFixed(1);
                    
                    return {
                        id: placeholder.position,
                        name: placeholder.position.charAt(0).toUpperCase() + placeholder.position.slice(1),
                        dimensions: `${placeholder.width}×${placeholder.height}px (${widthInches}×${heightInches}")`,
                        width: placeholder.width,
                        height: placeholder.height,
                        icon: getPrintAreaIcon(placeholder.position)
                    };
                });
                
            } catch (error) {
                console.error('Error fetching print areas:', error);
                
                // Fallback to mock data if API fails
                return [
                    {
                        id: 'front',
                        name: 'Front',
                        dimensions: '3000×3000px (10×10")',
                        width: 3000,
                        height: 3000,
                        icon: 'bi-square'
                    },
                    {
                        id: 'back',
                        name: 'Back',
                        dimensions: '3000×3000px (10×10")',
                        width: 3000,
                        height: 3000,
                        icon: 'bi-square'
                    }
                ];
            }
        }
        
        function getPrintAreaIcon(position) {
            const iconMap = {
                'front': 'bi-front',
                'back': 'bi-back',
                'left': 'bi-arrow-left-square',
                'right': 'bi-arrow-right-square',
                'center': 'bi-record-circle',
                'top': 'bi-arrow-up-square',
                'bottom': 'bi-arrow-down-square'
            };
            return iconMap[position] || 'bi-square';
        }

        function limitPrintAreas(checkbox) {
            const productId = checkbox.dataset.productId;
            const container = document.querySelector(`[data-product-id="${productId}"].print-areas-container`);
            const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
            
            if (checkedBoxes.length > 2) {
                checkbox.checked = false;
                // Show a subtle notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
                notification.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Maximum 2 print areas per product
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(notification);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }
        }

        function proceedToStep4() {
            // Collect print areas for each selected product
            const selectedProductIds = Array.from(BulkAppState.selectedProducts);
            const designs = selectedProductIds.map(productId => {
                const printAreaCheckboxes = document.querySelectorAll(`input[data-product-id="${productId}"].print-area-checkbox:checked`);
                const selectedAreas = Array.from(printAreaCheckboxes).map(cb => cb.value);
                
                return {
                    productId: productId,
                    printAreas: selectedAreas
                };
            });
            
            sessionStorage.setItem('bulkDesigns', JSON.stringify(designs));
            
            // Show final step
            document.getElementById('step3-container').classList.remove('active');
            document.getElementById('step4-container').classList.add('active');
            
            document.getElementById('step-indicator-3').classList.remove('active');
            document.getElementById('step-indicator-3').classList.add('completed');
            document.getElementById('step-indicator-4').classList.add('active');
            
            // Show generation interface
            populateStep4();
        }
        
        function populateStep4() {
            const step4Container = document.getElementById('step4-container');
            const selectedProductIds = JSON.parse(sessionStorage.getItem('bulkSelectedProducts') || '[]');
            const designs = JSON.parse(sessionStorage.getItem('bulkDesigns') || '[]');
            
            // Convert product IDs to full product objects
            const selectedProducts = allProducts.filter(p => selectedProductIds.includes(p.id.toString()));
            
            // Group print areas by similar sizes
            const printAreaSizes = groupPrintAreaSizes(designs, selectedProducts);
            
            step4Container.innerHTML = `
                <div class="row">
                    <!-- Design Generation Panel -->
                    <div class="col-lg-8">
                        <div class="card mb-4">
                            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <h4><i class="bi bi-magic"></i> AI Design Generation</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <label class="form-label fw-bold">Design Prompt</label>
                                        <textarea class="form-control mb-3" id="bulkPrompt" rows="3" 
                                                  placeholder="Describe your design idea... (e.g., 'Minimalist mountain landscape with geometric shapes')"
                                                  style="border-radius: 12px; border: 2px solid #e5e7eb; resize: vertical;"></textarea>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Print Area Sizes</label>
                                        <div class="size-selection">
                                            ${printAreaSizes.map(sizeGroup => `
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="size-${sizeGroup.id}" value="${sizeGroup.dimensions}" checked>
                                                    <label class="form-check-label small" for="size-${sizeGroup.id}">
                                                        <strong>${sizeGroup.dimensions}</strong><br>
                                                        <span class="text-muted">${sizeGroup.count} area${sizeGroup.count > 1 ? 's' : ''}</span>
                                                    </label>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Style</label>
                                        <select class="form-select" id="bulkStyle">
                                            <option value="modern">Modern</option>
                                            <option value="vintage">Vintage</option>
                                            <option value="minimalist">Minimalist</option>
                                            <option value="artistic">Artistic</option>
                                            <option value="trendy">Trendy</option>
                                            <option value="abstract">Abstract</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Colors</label>
                                        <select class="form-select" id="bulkColors">
                                            <option value="vibrant">Vibrant</option>
                                            <option value="pastel">Pastel</option>
                                            <option value="monochrome">Monochrome</option>
                                            <option value="earth">Earth Tones</option>
                                            <option value="neon">Neon</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Target</label>
                                        <select class="form-select" id="bulkAudience">
                                            <option value="young-adults">Young Adults</option>
                                            <option value="adults">Adults</option>
                                            <option value="mature">Mature</option>
                                            <option value="unisex">Unisex</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Model</label>
                                        <select class="form-select" id="bulkModel">
                                            <option value="flux-dev">Flux Dev</option>
                                            <option value="flux-schnell">Flux Schnell</option>
                                            <option value="flux-pro">Flux Pro</option>
                                            <option value="recraft-v3">Recraft V3</option>
                                            <option value="ideogram-v2">Ideogram V2</option>
                                            <option value="flux-lora">Flux LoRA</option>
                                            <option value="imagen4-preview">Imagen4 Preview</option>
                                            <option value="nano-banana">Nano Banana</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn btn-primary btn-lg" onclick="generateDesigns()" id="generateBtn">
                                        <i class="bi bi-magic"></i> Generate Designs
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="savePrompt()" id="savePromptBtn">
                                        <i class="bi bi-bookmark"></i> Save Prompt
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Generated Images Display -->
                        <div class="card" id="generatedImagesCard" style="display: none;">
                            <div class="card-header">
                                <h5><i class="bi bi-images"></i> Generated Designs</h5>
                            </div>
                            <div class="card-body" id="generatedImagesContainer">
                                <!-- Generated images will appear here -->
                            </div>
                        </div>
                        
                        <!-- Design Assignment Table -->
                        <div class="card mt-4" id="assignmentTableCard" style="display: none;">
                            <div class="card-header">
                                <h5><i class="bi bi-grid-3x3-gap"></i> Assign Designs to Print Areas</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="assignmentTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Product</th>
                                                <th>Print Area</th>
                                                <th>Size</th>
                                                <th>Assigned Design</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="assignmentTableBody">
                                            <!-- Assignment rows will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-4">
                                    <button class="btn btn-success btn-lg" onclick="createBulkProducts()" id="createProductsBtn" disabled>
                                        <i class="bi bi-check-circle"></i> Create All Products
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Sidebar -->
                    <div class="col-lg-4">
                        <div class="card sticky-top" style="top: 20px;">
                            <div class="card-header bg-light">
                                <h6><i class="bi bi-info-circle"></i> Project Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>Products:</strong> ${selectedProducts.length}
                                    <div class="small text-muted">
                                        ${selectedProducts.map(p => p.title).join(', ')}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <strong>Shop:</strong> ${sessionStorage.getItem('bulkSelectedShop') || 'Not selected'}
                                </div>
                                <div class="mb-3">
                                    <strong>Print Areas:</strong> ${designs.reduce((total, d) => total + d.printAreas.length, 0)}
                                </div>
                                <div class="mb-3">
                                    <strong>Unique Sizes:</strong> ${printAreaSizes.length}
                                    <div class="small text-muted">
                                        ${printAreaSizes.map(s => s.dimensions).join(', ')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6><i class="bi bi-lightbulb"></i> Pro Tips</h6>
                            </div>
                            <div class="card-body">
                                <small>
                                    <ul class="list-unstyled mb-0">
                                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Be specific in your prompts</li>
                                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Generate multiple sizes for versatility</li>
                                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Use edit tools to perfect designs</li>
                                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Save prompts for future use</li>
                                    </ul>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Global state for generated images
        let generatedImages = [];
        let assignmentData = {};
        
        function groupPrintAreaSizes(designs, selectedProducts) {
            const sizeGroups = new Map();
            
            designs.forEach(design => {
                const product = selectedProducts.find(p => p.id.toString() === design.productId.toString());
                if (!product) return;
                
                design.printAreas.forEach(areaId => {
                    // Get actual print area dimensions from cached API data
                    const printAreaData = JSON.parse(sessionStorage.getItem('printAreaData') || '{}');
                    const productAreas = printAreaData[design.productId] || [];
                    
                    const area = productAreas.find(a => a.id === areaId);
                    const dimensions = area ? `${area.width}×${area.height}px` : '3000×3000px';
                    
                    if (!sizeGroups.has(dimensions)) {
                        sizeGroups.set(dimensions, {
                            id: dimensions.replace(/[^\w]/g, ''),
                            dimensions: dimensions,
                            count: 0,
                            areas: [],
                            width: area ? area.width : 3000,
                            height: area ? area.height : 3000
                        });
                    }
                    
                    const group = sizeGroups.get(dimensions);
                    group.count++;
                    group.areas.push({ 
                        productId: design.productId, 
                areaId, 
                productTitle: product.title,
                width: area ? area.width : 3000,
                height: area ? area.height : 3000
            });
        });
    });
    
    return Array.from(sizeGroups.values()).sort((a, b) => b.count - a.count);
}
        
        async function generateDesigns() {
            const prompt = document.getElementById('bulkPrompt').value.trim();
            if (!prompt) {
                alert('Please enter a design prompt');
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
            
            try {
                // Get selected sizes
                const selectedSizes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                
                const style = document.getElementById('bulkStyle').value;
                const colors = document.getElementById('bulkColors').value;
                const audience = document.getElementById('bulkAudience').value;
                
                // Generate designs for each selected size
                const imagePromises = selectedSizes.map(size => 
                    generateImageForSize(prompt, size, style, colors, audience)
                );
                
                const results = await Promise.all(imagePromises);
                generatedImages = results.filter(r => r && r.image_url).map(r => ({ ...r, size: r.requestedSize }));
                
                console.log('Generated images:', generatedImages);
                displayGeneratedImages();
                populateAssignmentTable();
                
                // Automatically save generated images
                if (generatedImages.length > 0) {
                    await saveGeneratedImages();
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                alert('Error generating designs. Please try again.');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            }
        }
        
        async function generateImageForSize(prompt, size, style, colors, audience) {
            try {
                const selectedModel = document.getElementById('bulkModel')?.value || 'flux-dev';
                const response = await fetch('/.netlify/functions/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `${prompt}, ${style} style, ${colors} colors, for ${audience}, optimized for ${size} print area`,
                        model: selectedModel,
                        size: '1024x1024'
                    })
                });
                
                const result = await response.json();
                if (result.success && result.images) {
                    // Map the response format to expected format
                    return {
                        id: result.images[0]?.id || `bulk-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        image_url: result.images[0]?.url,
                        prompt: result.images[0]?.prompt,
                        width: result.images[0]?.width,
                        height: result.images[0]?.height,
                        requestedSize: size,
                        model: result.model
                    };
                }
                return null;
            } catch (error) {
                console.error('Error generating image for size', size, error);
                return null;
            }
        }
        
        function displayGeneratedImages() {
            console.log('displayGeneratedImages called with:', generatedImages.length, 'images');
            const container = document.getElementById('generatedImagesContainer');
            const card = document.getElementById('generatedImagesCard');
            
            if (!container || !card) {
                console.error('Container or card not found');
                return;
            }
            
            if (generatedImages.length === 0) {
                console.log('No images to display');
                card.style.display = 'none';
                return;
            }
            
            console.log('Showing card and displaying', generatedImages.length, 'images');
            card.style.display = 'block';
            
            container.innerHTML = `
                <div class="row g-3">
                    ${generatedImages.map((img, index) => {
                        console.log('Processing image', index, ':', img);
                        return `
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100 shadow-sm border">
                                <div class="position-relative">
                                    <img src="${img.image_url}" class="card-img-top" alt="Generated design" 
                                         style="height: 200px; object-fit: cover; border-radius: 8px 8px 0 0;"
                                         onerror="console.error('Failed to load image:', this.src)">
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-primary">${img.size || 'Unknown'}</span>
                                    </div>
                                </div>
                                <div class="card-body p-3">
                                    <div class="d-flex gap-2 mb-2">
                                        <button class="btn btn-sm btn-outline-primary flex-fill" 
                                                onclick="editImage(${index})">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary flex-fill" 
                                                onclick="removeBackground(${index})">
                                            <i class="bi bi-scissors"></i> Remove BG
                                        </button>
                                    </div>
                                    <small class="text-muted">ID: ${img.id || index}</small>
                                </div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-success" onclick="saveGeneratedImages()">
                        <i class="bi bi-save"></i> Save All Images
                    </button>
                </div>
            `;
            
            console.log('Images displayed successfully');
        }

        async function editImage(index) {
            if (!generatedImages[index]) {
                alert('Image not found');
                return;
            }
            
            const image = generatedImages[index];
            const newPrompt = prompt('Enter new prompt for editing:', image.prompt || '');
            if (!newPrompt) return;
            
            const editBtn = event.target;
            const originalText = editBtn.innerHTML;
            editBtn.disabled = true;
            editBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Editing...';
            
            try {
                console.log('Sending edit request:', {
                    imageUrl: image.image_url,
                    prompt: newPrompt
                });
                
                const response = await fetch('/.netlify/functions/edit-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        imageUrl: image.image_url,
                        prompt: newPrompt
                    })
                });
                
                console.log('Edit response status:', response.status);
                console.log('Edit response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Edit response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    generatedImages[index] = { ...image, ...result.data, prompt: newPrompt };
                    displayGeneratedImages();
                    alert('Image edited successfully!');
                } else {
                    alert('Error editing image: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error editing image:', error);
                alert('Error editing image: ' + error.message);
            } finally {
                editBtn.disabled = false;
                editBtn.innerHTML = originalText;
            }
        }

        async function removeBackground(index) {
            if (!generatedImages[index]) {
                alert('Image not found');
                return;
            }
            
            const image = generatedImages[index];
            const removeBtn = event.target;
            const originalText = removeBtn.innerHTML;
            removeBtn.disabled = true;
            removeBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Removing...';
            
            try {
                const response = await fetch('/.netlify/functions/remove-background', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        imageUrl: image.image_url,
                        designId: image.id
                    })
                });
                
                // First check if the response is OK (status 200-299)
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server responded with status ${response.status}: ${errorText}`);
                }
                
                // Try to parse the response as JSON
                let result;
                try {
                    const text = await response.text();
                    result = text ? JSON.parse(text) : {};
                } catch (parseError) {
                    console.error('Error parsing response:', parseError);
                    throw new Error('Invalid response from server. Please try again.');
                }
                
                if (result && result.success && result.data && result.data.image_url) {
                    generatedImages[index] = { ...image, image_url: result.data.image_url };
                    displayGeneratedImages();
                    alert('Background removed successfully!');
                } else {
                    throw new Error(result.error || 'Failed to process image. Please try again.');
                }
            } catch (error) {
                console.error('Error removing background:', error);
                alert('Error removing background: ' + error.message);
            } finally {
                removeBtn.disabled = false;
                removeBtn.innerHTML = originalText;
            }
        }
        
        async function populateAssignmentTable() {
            const tableBody = document.getElementById('assignmentTableBody');
            const tableCard = document.getElementById('assignmentTableCard');
            const selectedProducts = JSON.parse(sessionStorage.getItem('bulkSelectedProducts') || '[]');
            const designs = JSON.parse(sessionStorage.getItem('bulkDesigns') || '[]');
            
            if (generatedImages.length === 0) {
                tableCard.style.display = 'none';
                return;
            }
            
            tableCard.style.display = 'block';
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border"></div> Loading print area details...</td></tr>';
            
            try {
                const token = localStorage.getItem('authToken');
                if (!token) throw new Error('Authentication required');
                
                // Fetch all print areas for all products in parallel
                const printAreaPromises = designs.map(async (design) => {
                    const product = selectedProducts.find(p => p.id === design.productId);
                    if (!product || !product.blueprint_id) return [];
                    
                    try {
                        // Fetch print providers for this blueprint
                        const providersRes = await fetch('/.netlify/functions/printify-proxy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({
                                endpoint: `/v1/catalog/blueprints/${product.blueprint_id}/print_providers.json`,
                                method: 'GET'
                            })
                        });
                        
                        if (!providersRes.ok) throw new Error('Failed to fetch print providers');
                        const providers = await providersRes.json();
                        if (!providers.length) return [];
                        
                        // Use the first provider's variants
                        const providerId = providers[0].id;
                        const variantsRes = await fetch('/.netlify/functions/printify-proxy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({
                                endpoint: `/v1/catalog/blueprints/${product.blueprint_id}/print_providers/${providerId}/variants.json`,
                                method: 'GET'
                            })
                        });
                        
                        if (!variantsRes.ok) throw new Error('Failed to fetch variants');
                        const variants = await variantsRes.json();
                        
                        // Get all unique print areas from variants
                        const printAreas = new Map();
                        variants.variants.forEach(variant => {
                            variant.placements.forEach(placement => {
                                if (placement.print_area_cover && placement.print_area_size) {
                                    printAreas.set(placement.position, {
                                        id: placement.position,
                                        name: placement.position.replace(/_/g, ' ').toUpperCase(),
                                        size: `${placement.print_area_size.width}×${placement.print_area_size.height} mm`,
                                        width: placement.print_area_size.width,
                                        height: placement.print_area_size.height
                                    });
                                }
                            });
                        });
                        
                        // Only return print areas that were selected in the design
                        return design.printAreas
                            .filter(areaId => printAreas.has(areaId))
                            .map(areaId => ({
                                ...printAreas.get(areaId),
                                productId: design.productId,
                                productTitle: product?.title || 'Unknown Product',
                                rowId: `${design.productId}-${areaId}`
                            }));
                        
                    } catch (error) {
                        console.error(`Error fetching print areas for product ${design.productId}:`, error);
                        // Fallback to basic print area info if API fails
                        return design.printAreas.map(areaId => ({
                            id: areaId,
                            name: areaId.replace('_', ' ').toUpperCase(),
                            size: 'Size not available',
                            width: 0,
                            height: 0,
                            productId: design.productId,
                            productTitle: product?.title || 'Unknown Product',
                            rowId: `${design.productId}-${areaId}`
                        }));
                    }
                });
                
                // Wait for all print area fetches to complete
                const printAreaResults = await Promise.all(printAreaPromises);
                const rows = printAreaResults.flat();
                
                if (rows.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No print areas found for selected products</td></tr>';
                    return;
                }
                
                // Render the table with the fetched print areas
                tableBody.innerHTML = rows.map(row => `
                    <tr>
                        <td>
                            <strong>${row.productTitle}</strong><br>
                            <small class="text-muted">ID: ${row.productId}</small>
                        </td>
                        <td>${row.name}</td>
                        <td><span class="badge bg-info">${row.size}</span></td>
                        <td>
                            <select class="form-select form-select-sm" id="assign-${row.id}" 
                                    onchange="updateAssignment('${row.id}', this.value)">
                                <option value="">Select Design...</option>
                                ${generatedImages.map((img, index) => `
                                    <option value="${index}" ${img.size === row.size ? 'selected' : ''}>
                                        Design ${index + 1} (${img.size || 'Custom'})
                                    </option>
                                `).join('')}
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="previewAssignment('${row.id}')">
                                <i class="bi bi-eye"></i> Preview
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                // Auto-assign matching sizes if possible
                rows.forEach(row => {
                    const matchingImage = generatedImages.findIndex(img => img.size === row.size);
                    if (matchingImage !== -1) {
                        const selectEl = document.getElementById(`assign-${row.id}`);
                        if (selectEl) {
                            selectEl.value = matchingImage;
                            updateAssignment(row.id, matchingImage);
                        }
                    }
                });
            } catch (error) {
                console.error('Error populating assignment table:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            Error loading print area details. ${error.message || ''}
                        </td>
                    </tr>`;
            }
        }
        
        function updateAssignment(rowId, imageIndex) {
            if (imageIndex === '') {
                delete assignmentData[rowId];
            } else {
                assignmentData[rowId] = parseInt(imageIndex);
            }
            
            // Enable/disable create button based on assignments
            const totalRows = document.querySelectorAll('#assignmentTableBody tr').length;
            const assignedRows = Object.keys(assignmentData).length;
            const createBtn = document.getElementById('createProductsBtn');
            
            createBtn.disabled = assignedRows === 0;
            createBtn.innerHTML = `<i class="bi bi-check-circle"></i> Create Products (${assignedRows}/${totalRows} assigned)`;
        }
        
        async function savePrompt() {
            const prompt = document.getElementById('bulkPrompt').value.trim();
            if (!prompt) {
                alert('Please enter a prompt to save');
                return;
            }
            
            const saveBtn = document.getElementById('savePromptBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
            
            try {
                const response = await fetch('/.netlify/functions/save-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        response: {
                            title: 'Bulk Generation Prompt',
                            description: `${document.getElementById('bulkStyle').value} style, ${document.getElementById('bulkColors').value} colors, for ${document.getElementById('bulkAudience').value}`,
                            brand: 'Bulk Creator'
                        },
                        metadata: {
                            style: document.getElementById('bulkStyle').value,
                            colors: document.getElementById('bulkColors').value,
                            audience: document.getElementById('bulkAudience').value,
                            context: 'bulk-generation'
                        }
                    })
                });
                
                const result = await response.json();
                alert('Prompt saved successfully!');
            } catch (error) {
                console.error('Save prompt error:', error);
                alert('Error saving prompt. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }
        
        async function saveGeneratedImages() {
            if (generatedImages.length === 0) {
                alert('No images to save');
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/save-generated-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: generatedImages,
                        context: 'bulk-generation',
                        metadata: {
                            prompt: document.getElementById('bulkPrompt').value,
                            style: document.getElementById('bulkStyle').value,
                            colors: document.getElementById('bulkColors').value,
                            audience: document.getElementById('bulkAudience').value
                        }
                    })
                });
                
                const result = await response.json();
                alert('Images saved successfully!');
            } catch (error) {
                console.error('Save images error:', error);
                alert('Error saving images. Please try again.');
            }
        }
        
        function previewAssignment(rowId) {
            const imageIndex = assignmentData[rowId];
            if (imageIndex === undefined) {
                alert('No design assigned to this print area');
                return;
            }
            
            const image = generatedImages[imageIndex];
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Design Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${image.image_url}" class="img-fluid" alt="Design preview">
                            <p class="mt-3">Size: ${image.size}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        async function createBulkProducts() {
            const assignedCount = Object.keys(assignmentData).length;
            if (assignedCount === 0) {
                alert('Please assign designs to print areas before creating products');
                return;
            }
            
            const createBtn = document.getElementById('createProductsBtn');
            const originalText = createBtn.innerHTML;
            createBtn.disabled = true;
            createBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating Products...';
            
            try {
                // Get selected shop and products
                const shopId = sessionStorage.getItem('bulkSelectedShop');
                const selectedProducts = JSON.parse(sessionStorage.getItem('bulkSelectedProducts') || '[]');
                const designs = JSON.parse(sessionStorage.getItem('bulkDesigns') || '[]');
                
                // Fetch print providers for all products at once for efficiency
                const providersResponse = await fetch('/.netlify/functions/get-print-providers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        blueprintIds: selectedProducts
                    })
                });
                
                const providersData = await providersResponse.json();
                const productsWithProviders = providersData.data || selectedProducts.map(productId => ({
                    blueprintId: productId,
                    printProviderId: null,
                    printProviders: [],
                    success: false
                }));
                
                const response = await fetch('/.netlify/functions/save-bulk-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shop: shopId,
                        products: productsWithProviders,
                        designs: designs,
                        assignments: assignmentData,
                        generatedImages: generatedImages
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`Successfully created ${assignedCount} product assignments!`);
                    // Optionally redirect to dashboard or show success page
                } else {
                    throw new Error(result.error || 'Failed to create products');
                }
            } catch (error) {
                console.error('Create products error:', error);
                alert('Error creating products. Please try again.');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>