<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick AI System Diagnostic</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .status-ok { color: #28a745; }
    .status-failed { color: #dc3545; }
    .status-skipped { color: #ffc107; }
    pre { font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <h1 class="mb-4">üîß Quick AI System Diagnostic</h1>
        
        <div class="card">
          <div class="card-body">
            <button id="runTest" class="btn btn-primary mb-3">Run Diagnostic Test</button>
            <div id="loading" style="display:none;" class="text-center mb-3">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <div>Running diagnostic tests...</div>
            </div>
            <div id="results"></div>
          </div>
        </div>

        <div class="mt-4">
          <h3>What This Tests:</h3>
          <ul>
            <li><strong>Environment Variables:</strong> Checks if all required API keys are set</li>
            <li><strong>Database Connection:</strong> Tests if can connect to your database</li>
            <li><strong>Gemini AI:</strong> Verifies Gemini API key works</li>
            <li><strong>FAL AI:</strong> Tests image generation API</li>
            <li><strong>Quick Jobs Table:</strong> Ensures database table exists and works</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('runTest').onclick = async function() {
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');
      const button = document.getElementById('runTest');
      
      button.disabled = true;
      loading.style.display = 'block';
      results.innerHTML = '';
      
      try {
        const response = await fetch('/.netlify/functions/quick-ai-diagnostic');
        const data = await response.json();
        
        let html = '<h4>Test Results</h4>';
        
        // Summary
        const summary = data.summary;
        const summaryClass = summary.overall === 'READY' ? 'status-ok' : 'status-failed';
        html += `
          <div class="alert ${summary.overall === 'READY' ? 'alert-success' : 'alert-warning'}">
            <strong>Overall Status: <span class="${summaryClass}">${summary.overall}</span></strong><br>
            Passed: ${summary.passed} | Failed: ${summary.failed} | Skipped: ${summary.skipped}
          </div>
        `;
        
        // Individual tests
        html += '<div class="row">';
        for (const [testName, testResult] of Object.entries(data.tests || {})) {
          if (!testResult || typeof testResult !== 'object') continue;
          
          const status = testResult.status || 'UNKNOWN';
          const statusClass = `status-${status.toLowerCase()}`;
          const icon = status === 'OK' ? '‚úÖ' : status === 'FAILED' ? '‚ùå' : '‚ö†Ô∏è';
          
          html += `
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title">${icon} ${testName.replace(/_/g, ' ').toUpperCase()}</h6>
                  <div class="${statusClass}"><strong>${status}</strong></div>
                  ${testResult.message ? `<div class="small text-muted">${testResult.message}</div>` : ''}
                  ${testResult.error ? `<div class="small text-danger">${testResult.error}</div>` : ''}
                  ${testResult.response ? `<div class="small text-success">Response: ${testResult.response}</div>` : ''}
                </div>
              </div>
            </div>
          `;
        }
        html += '</div>';
        
        // Environment details
        if (data.tests.environment) {
          html += '<h5>Environment Variables Status</h5><ul>';
          for (const [key, value] of Object.entries(data.tests.environment)) {
            const icon = value ? '‚úÖ' : '‚ùå';
            html += `<li>${icon} ${key}: ${value ? 'SET' : 'MISSING'}</li>`;
          }
          html += '</ul>';
        }
        
        // Raw data
        html += `
          <details class="mt-3">
            <summary>Raw Test Data</summary>
            <pre class="bg-light p-2 mt-2">${JSON.stringify(data, null, 2)}</pre>
          </details>
        `;
        
        results.innerHTML = html;
        
      } catch (error) {
        results.innerHTML = `
          <div class="alert alert-danger">
            <strong>Test Failed:</strong> ${error.message}
          </div>
        `;
      } finally {
        loading.style.display = 'none';
        button.disabled = false;
      }
    };
  </script>
</body>
</html>
