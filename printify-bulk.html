<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Printify Bulk Image Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root { --primary:#0ea5e9; --radius:12px; }
        body{ background:#f8fafc; font-family:Inter,sans-serif;}
        .card{border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,.06)}
        .btn-primary{background:var(--primary);border:none}
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: var(--radius);
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background-color: #f0f9ff;
        }
        .product-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .product-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .product-card.selected {
            border-color: var(--primary);
            background-color: #f0f9ff;
        }
        .progress-container {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: contain;
            border-radius: var(--radius);
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand" href="index.html">Printify Manager</a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li><a class="nav-link" href="bulkly.html">Bulk Creator (Printful)</a></li>
        <li><a class="nav-link active" href="printify-bulk.html">Printify Bulk</a></li>
        <li><a class="nav-link" href="pricing.html">Manage Pricing</a></li>
        <li><a class="nav-link" href="inspiration.html">Inspiration</a></li>
      </ul>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3">Welcome!</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>

<!-- Media Library Modal -->
<div class="modal fade" id="mediaLibraryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-collection"></i> Media Library</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex mb-3">
          <input id="mediaSearch" class="form-control" placeholder="Search by file name..." oninput="filterMediaGrid()"/>
          <button class="btn btn-outline-secondary ms-2" onclick="reloadMediaLibrary()"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
        <div id="mediaGrid" class="row g-3">
          <!-- Thumbnails here -->
        </div>
        <div id="mediaEmpty" class="text-center text-muted d-none">
          <p class="mt-4"><i class="bi bi-inbox"></i> No images found in your media library.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
 </div>
    </div>
  </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-images"></i> Printify Bulk Image Manager
                    </h4>
                    <small class="text-muted">Upload one image and apply it to multiple Printify products</small>
                </div>
                <div class="card-body">
                    <!-- Step 1: Image Upload -->
                    <div id="step1" class="step-container active">
                        <h5 class="mb-3">Step 1: Upload Your Design</h5>
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('imageInput').click()">
                            <div id="uploadContent">
                                <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                                <h6>Click to upload or drag & drop</h6>
                                <p class="text-muted mb-0">PNG, JPG up to 50MB</p>
                            </div>
                            <div id="imagePreview" style="display: none;">
                                <img id="previewImage" class="image-preview mb-3" alt="Preview">
                                <div>
                                    <h6 id="imageName"></h6>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearImage()">
                                        <i class="bi bi-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        
                        <div class="mt-4">
                            <button id="uploadBtn" class="btn btn-primary" onclick="uploadToMediaLibrary()" disabled>
                                <i class="bi bi-upload"></i> Upload to Printify Media Library
                            </button>
                            <button id="browseLibraryBtn" class="btn btn-outline-secondary ms-2" onclick="openMediaLibrary()">
                                <i class="bi bi-collection"></i> Browse Media Library
                            </button>
                            <div class="small text-muted mt-2" id="imageDims" style="display:none;"></div>
                        </div>
                    </div>

                    <!-- Step 2: Product Selection -->
                    <div id="step2" class="step-container">
                        <h5 class="mb-3">Step 2: Select Products</h5>
                        <div class="row mb-3 g-2 align-items-end">
                            <div class="col-md-4">
                                <label for="shopSelect" class="form-label">Store</label>
                                <select id="shopSelect" class="form-select" onchange="onShopChange()">
                                    <option value="" selected disabled>Loading stores…</option>
                                </select>
                                <div class="form-text">Choose which Printify store to create products in.</div>
                            </div>
                            <div class="col-md-8">
                                <label for="categoryFilter" class="form-label">Category</label>
                                <select id="categoryFilter" class="form-select" onchange="filterProducts()">
                                    <option value="">All Categories</option>
                                    <option value="apparel">Apparel</option>
                                    <option value="accessories">Accessories</option>
                                    <option value="home-living">Home & Living</option>
                                    <option value="stationery">Stationery</option>
                                </select>
                            </div>
                            <div class="col-md-12 text-md-end mt-2">
                                <button class="btn btn-outline-primary" onclick="selectAllProducts()">
                                    <i class="bi bi-check-all"></i> Select All
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="clearAllProducts()">
                                    <i class="bi bi-x-circle"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div id="productsGrid" class="row">
                            <!-- Products will be loaded here -->
                        </div>
                        
                        <div class="mt-4">
                            <button id="createProductsBtn" class="btn btn-success" onclick="createBulkProducts()" disabled>
                                <i class="bi bi-plus-circle"></i> Create Selected Products
                            </button>
                            <span id="selectedCount" class="ms-3 text-muted">0 products selected</span>
                        </div>
                    </div>

                    <!-- Step 3: Results -->
                    <div id="step3" class="step-container">
                        <h5 class="mb-3">Step 3: Results</h5>
                        <div id="resultsContainer">
                            <!-- Results will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Notification -->
<div id="progressContainer" class="progress-container">
    <div class="alert alert-info">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <div class="flex-grow-1">
                <h6 class="mb-1" id="progressTitle">Processing...</h6>
                <div class="progress mb-2" style="height: 6px;">
                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
                <small id="progressStatus">Starting...</small>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Import existing API helper functions from bulkly.html
const IS_PRINTFUL = false; // We're using Printify

// API helper function (matches bulkly.html implementation)
async function makeApiCall(endpoint, options = {}) {
  const token = localStorage.getItem('authToken');
  const extraHeaders = options.headers || {};
  const resp = await fetch('/.netlify/functions/printify-proxy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
    body: JSON.stringify({ 
      endpoint, 
      method: options.method || 'GET', 
      body: options.body,
      ...extraHeaders 
    })
  });
  return await resp.json();
}

// Simple HTML escape helper (same as in bulkly.html)
function escapeHtml(s) {
  try {
    return String(s || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  } catch(_) { return ''; }
}

// Get default shop ID helper
function getDefaultShopId() {
  // Try to get from existing session or return a default
  return sessionStorage.getItem('printifyShopId') || '1';
}

// Global state
let uploadedImageId = null;
let uploadedImageUrl = null;
let selectedProducts = new Set();
let availableProducts = [];
let selectedImageMeta = null; // { width, height }
// Map of productId/blueprintId to chosen { providerId, variantId, areaW, areaH }
const selectedPrintAreas = {};

// DPI calculation helper functions
function parseSizeKey(sk) {
    if (!sk) return { w: 0, h: 0 };
    const m = sk.match(/^(\d+)x(\d+)$/);
    if (!m) return { w: 0, h: 0 };
    return { w: parseInt(m[1], 10), h: parseInt(m[2], 10) };
}

// Estimate DPI assuming print areas are defined at 300 DPI (Printify templates)
function computeDPI(sizeKey, scaleVal) {
    const { w: areaW, h: areaH } = parseSizeKey(sizeKey);
    if (!areaW || !areaH) return null;
    // Assume image matches this sizeKey (we only allow matching in the table)
    const imgW = areaW;
    const imgH = areaH;
    const scale = Number(scaleVal) || 1.0;
    const scaledW = imgW * scale;
    const scaledH = imgH * scale;
    return Math.min((scaledW / areaW) * 300, (scaledH / areaH) * 300);
}

// Wrapper for DPI used in table rows
function computeDPIForSize(sizeKey, scaleVal) {
    return computeDPI(sizeKey, scaleVal);
}

// Sample product data (replace with actual Printify catalog API calls)
const sampleProducts = [
    { id: 1, name: "Unisex T-Shirt", category: "apparel", blueprint_id: 384, variant_id: 11336, price: 19.99, image: "https://via.placeholder.com/150x150?text=T-Shirt" },
    { id: 2, name: "Hoodie", category: "apparel", blueprint_id: 385, variant_id: 11337, price: 39.99, image: "https://via.placeholder.com/150x150?text=Hoodie" },
    { id: 3, name: "Coffee Mug", category: "home-living", blueprint_id: 386, variant_id: 11338, price: 14.99, image: "https://via.placeholder.com/150x150?text=Mug" },
    { id: 4, name: "Tote Bag", category: "accessories", blueprint_id: 387, variant_id: 11339, price: 16.99, image: "https://via.placeholder.com/150x150?text=Bag" },
    { id: 5, name: "Poster", category: "home-living", blueprint_id: 388, variant_id: 11340, price: 12.99, image: "https://via.placeholder.com/150x150?text=Poster" },
    { id: 6, name: "Sticker", category: "stationery", blueprint_id: 389, variant_id: 11341, price: 3.99, image: "https://via.placeholder.com/150x150?text=Sticker" }
];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupDragAndDrop();
    loadShops();
});

// Drag and drop functionality
function setupDragAndDrop() {
    const uploadZone = document.getElementById('uploadZone');
    
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleImageFile(files[0]);
        }
    });
}

// Handle image upload
function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
        handleImageFile(file);
    }
}

function handleImageFile(file) {
    // Validate file
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
    }
    
    if (file.size > 50 * 1024 * 1024) { // 50MB limit
        alert('File size must be less than 50MB');
        return;
    }
    
    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('previewImage').src = e.target.result;
        document.getElementById('imageName').textContent = file.name;
        document.getElementById('uploadContent').style.display = 'none';
        document.getElementById('imagePreview').style.display = 'block';
        document.getElementById('uploadBtn').disabled = false;

        // Derive actual image dimensions from the file (no mock values)
        const img = new Image();
        img.onload = function() {
            selectedImageMeta = { width: img.naturalWidth, height: img.naturalHeight };
            console.log('[Local File] natural size:', selectedImageMeta.width, 'x', selectedImageMeta.height, 'name:', file.name);
            const dims = document.getElementById('imageDims');
            if (dims) { dims.style.display = 'block'; dims.textContent = `Image size (local file): ${selectedImageMeta.width} × ${selectedImageMeta.height} px`; }
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    
    // Store file for upload
    window.selectedImageFile = file;
}

function clearImage() {
    document.getElementById('uploadContent').style.display = 'block';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('imageInput').value = '';
    window.selectedImageFile = null;
    uploadedImageId = null;
    uploadedImageUrl = null;
}

// Upload to Printify Media Library using existing proxy
async function uploadToMediaLibrary() {
    if (!window.selectedImageFile) return;
    
    showProgress('Uploading to Printify Media Library...', 0);
    
    try {
        // Convert file to base64
        const base64 = await fileToBase64(window.selectedImageFile);
        
        // Upload via existing Printify proxy
        const response = await makeApiCall('/v1/uploads/images.json', {
            method: 'POST',
            body: {
                file_name: window.selectedImageFile.name,
                contents: base64.split(',')[1] // Remove data:image/... prefix
            }
        });
        
        if (!response.success) {
            throw new Error(response.error || 'Upload failed');
        }
        
        uploadedImageId = response.data.id;
        uploadedImageUrl = response.data.preview_url;
        // Capture dimensions if present
        if (typeof response.data.width === 'number' && typeof response.data.height === 'number') {
            selectedImageMeta = { width: response.data.width, height: response.data.height };
            console.log('[Printify Upload] size from API:', selectedImageMeta.width, 'x', selectedImageMeta.height, 'file:', window.selectedImageFile?.name);
            const dims = document.getElementById('imageDims');
            if (dims) { dims.style.display = 'block'; dims.textContent = `Image size (Printify upload): ${selectedImageMeta.width} × ${selectedImageMeta.height} px`; }
        }
        
        updateProgress('Upload complete!', 100);
        setTimeout(() => {
            hideProgress();
            showStep(2);
            renderProducts();
        }, 1000);
        
    } catch (error) {
        console.error('Upload error:', error);
        hideProgress();
        alert('Upload failed: ' + error.message);
    }
}

// Load products
async function loadShops() {
    try {
        const sel = document.getElementById('shopSelect');
        sel.innerHTML = '<option disabled selected>Loading stores…</option>';
        const resp = await makeApiCall('/shops.json', { method: 'GET' });
        if (!resp.success) throw new Error(resp.error || 'Failed to load shops');
        const shops = Array.isArray(resp.data?.data) ? resp.data.data : resp.data;
        if (!Array.isArray(shops) || shops.length === 0) {
            sel.innerHTML = '<option disabled selected>No stores found</option>';
            return;
        }
        sel.innerHTML = shops.map(s => `<option value="${s.id}">${escapeHtml(s.title || s.name || 'Store ' + s.id)}</option>`).join('');
        // Restore previously selected shop if any
        const stored = sessionStorage.getItem('printifyShopId') || sessionStorage.getItem('bulkSelectedShop');
        if (stored && shops.some(s => String(s.id) === String(stored))) {
            sel.value = stored;
        }
        onShopChange();
    } catch (e) {
        console.error('Failed to load shops:', e);
        const sel = document.getElementById('shopSelect');
        if (sel) sel.innerHTML = '<option disabled selected>Error loading stores</option>';
    }
}

function onShopChange() {
    const sel = document.getElementById('shopSelect');
    const shopId = sel && sel.value ? sel.value : null;
    if (shopId) {
        sessionStorage.setItem('printifyShopId', shopId);
        sessionStorage.setItem('bulkSelectedShop', shopId);
        loadProducts();
    }
}

// Load real catalog blueprints from Printify
async function loadProducts() {
    try {
        showProgress('Loading catalog…', 10);
        // Fetch blueprints (catalog products)
        const resp = await makeApiCall('/catalog/blueprints.json?page=1&limit=50', { method: 'GET' });
        if (!resp.success) throw new Error(resp.error || 'Failed to load catalog');
        const blueprints = Array.isArray(resp.data?.data) ? resp.data.data : resp.data;
        availableProducts = (blueprints || []).map(bp => ({
            id: bp.id,
            name: bp.title || bp.name || `Blueprint ${bp.id}`,
            category: (bp.category?.slug || bp.category || '').toString().toLowerCase(),
            blueprint_id: bp.id,
            brand: (bp.brand?.title || bp.brand || bp.brand_name || ''),
            // Price is provider/variant-specific; defer until creation time
            price: null,
            // defer variant/provider resolution until create time
            image: (bp.images && bp.images[0]) ? (bp.images[0].src || bp.images[0].url || bp.images[0]) : 'https://via.placeholder.com/150x150?text=Product'
        }));
        hideProgress();
        renderProducts();
    } catch (e) {
        console.error('Catalog load error:', e);
        hideProgress();
        // Fallback to sample products if needed
        availableProducts = sampleProducts;
        renderProducts();
    }
}

function renderProducts() {
    const grid = document.getElementById('productsGrid');
    const categoryFilter = document.getElementById('categoryFilter').value;
    
    let filteredProducts = categoryFilter 
        ? availableProducts.filter(p => p.category === categoryFilter)
        : availableProducts;
    
    grid.innerHTML = filteredProducts.map(product => {
        const subtitle = product.brand ? product.brand : (typeof product.price === 'number' ? `$${product.price}` : '');
        const pa = selectedPrintAreas[product.id] || selectedPrintAreas[product.blueprint_id];
        return `
        <div class="col-md-4 col-lg-3 mb-3">
            <div class="card product-card h-100 ${selectedProducts.has(product.id) ? 'selected' : ''}" 
                 onclick="toggleProduct(${product.id})">
                <img src="${product.image}" class="card-img-top" alt="${product.name}" style="height: 150px; object-fit: cover;">
                <div class="card-body">
                    <h6 class="card-title">${product.name}</h6>
                    ${pa ? `<div class=\"small text-muted\">Chosen: Provider ${pa.providerId}, Variant ${pa.variantId}, Area ${pa.areaW}×${pa.areaH}px</div>` : ''}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" 
                                ${!product.blueprint_id ? 'disabled title="No blueprint id available"' : ''}
                                onclick="event.stopPropagation(); ${!product.blueprint_id ? '' : `openPrintAreaModal(${product.blueprint_id})`}">
                          Choose Print Area
                        </button>
                    </div>
                    ${subtitle ? `<p class=\"card-text text-muted small\">${escapeHtml(subtitle)}</p>` : ''}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" ${selectedProducts.has(product.id) ? 'checked' : ''} 
                               onchange="toggleProduct(${product.id})">
                        <label class="form-check-label small">Select</label>
                    </div>
                </div>
            </div>
        </div>
    `}).join('');
}

function filterProducts() { renderProducts(); }

function fitsPrintArea(areaW, areaH, minW, minH) {
    // Accept if area width/height meet or exceed the minimums (0 means no minimum)
    const okW = !minW || (typeof areaW === 'number' && areaW >= minW);
    const okH = !minH || (typeof areaH === 'number' && areaH >= minH);
    return !!(okW && okH);
}

// Print Area Selection Modal
function openPrintAreaModal(blueprintId) {
    if (!window._paModal) window._paModal = new bootstrap.Modal(document.getElementById('printAreaModal'));
    document.getElementById('paModalBody').innerHTML = `
      <div class="mb-3">
        <label class="form-label">Print Provider</label>
        <select id="paProviderSelect" class="form-select" disabled>
          <option>Loading providers…</option>
        </select>
      </div>
      <div id="paAreasContainer">
        <div class="text-center text-muted py-4">Select a provider to view print areas.</div>
      </div>
    `;
    window._paModal.show();
    loadPrintAreas(blueprintId);
}

async function loadPrintAreas(blueprintId) {
    try {
        const providersResp = await makeApiCall(`/v1/catalog/blueprints/${blueprintId}/print_providers.json`, { method: 'GET' });
        if (!providersResp.success) throw new Error(providersResp.error || 'Failed to load providers');
        const providers = Array.isArray(providersResp.data?.data) ? providersResp.data.data : providersResp.data;
        const sel = document.getElementById('paProviderSelect');
        const areasEl = document.getElementById('paAreasContainer');
        if (!providers || providers.length === 0) {
            if (sel) { sel.innerHTML = '<option>No providers available</option>'; sel.disabled = true; }
            if (areasEl) areasEl.innerHTML = '<div class="text-center text-muted py-4">No providers available for this product.</div>';
            return;
        }
        // Populate dropdown
        sel.disabled = false;
        sel.innerHTML = providers.map(p => `<option value="${p.id}">${escapeHtml(p.title || ('Provider '+p.id))}</option>`).join('');
        sel.onchange = () => {
            const pid = sel.value;
            loadProviderAreas(blueprintId, pid);
        };
        // Auto-load first provider
        loadProviderAreas(blueprintId, providers[0].id);
    } catch (e) {
        const areasEl = document.getElementById('paAreasContainer');
        if (areasEl) areasEl.innerHTML = `<div class="text-danger">${escapeHtml(e.message)}</div>`;
    }
}

async function loadProviderAreas(blueprintId, providerId) {
    const areasEl = document.getElementById('paAreasContainer');
    if (areasEl) areasEl.innerHTML = '<div class="text-center text-muted py-4">Loading print areas…</div>';
    try {
        const detailsResp = await makeApiCall(`/v1/catalog/blueprints/${blueprintId}/print_providers/${Number(providerId)}/variants.json`, { method: 'GET' });
        if (!detailsResp.success) throw new Error(detailsResp.error || 'Failed to load provider variants');
        const providerData = detailsResp.data?.data || detailsResp.data;
        const variants = Array.isArray(providerData?.variants) ? providerData.variants : [];
        let items = [];
        const firstVariant = variants.length ? variants[0] : null;
        const placeholders = firstVariant && Array.isArray(firstVariant.placeholders) ? firstVariant.placeholders : [];
        for (const ph of placeholders) {
            const variantId = firstVariant?.id || 0;
            items.push(`
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
              <div>
                <div class="small text-muted">Position: ${escapeHtml(ph.position || 'front')}</div>
                <div>Area: ${ph.width} × ${ph.height} px</div>
                <div class="small text-muted">Variant: ${variantId || 'n/a'}</div>
              </div>
              <div>
                <button class="btn btn-sm btn-primary" onclick="choosePrintArea(${blueprintId}, ${Number(providerId)}, ${variantId || 0}, ${ph.width || 0}, ${ph.height || 0})">Select</button>
              </div>
            </div>`);
        }
        if (!items.length) {
            if (areasEl) areasEl.innerHTML = '<div class="text-center text-muted py-4">No print areas found for this provider.</div>';
        } else {
            const uid = `${blueprintId}_${providerId}`;
            const visible = items.slice(0, 2).join('');
            const hidden = items.slice(2).join('');
            const hasMore = items.length > 2;
            const html = `
              ${visible}
              ${hasMore ? `<div id="paMore_${uid}" style="display:none">${hidden}</div>` : ''}
              ${hasMore ? `<div class="text-center mt-2"><button id="paMoreBtn_${uid}" class="btn btn-sm btn-outline-secondary" onclick="(function(){const more=document.getElementById('paMore_${uid}');const btn=document.getElementById('paMoreBtn_${uid}');if(!more||!btn)return;const open=more.style.display!=='none';more.style.display=open?'none':'block';btn.textContent=open?'Show more':'Show less';})()">Show more</button></div>` : ''}
            `;
            if (areasEl) areasEl.innerHTML = html;
        }
    } catch (e) {
        if (areasEl) areasEl.innerHTML = `<div class="text-danger">${escapeHtml(e.message)}</div>`;
    }
}

function choosePrintArea(blueprintId, providerId, variantId, areaW, areaH) {
    selectedPrintAreas[blueprintId] = { providerId, variantId, areaW, areaH };
    if (window._paModal) window._paModal.hide();
    // 300 DPI recommendation: check if image dimensions are at least as large as print area (consider rotation)
    if (selectedImageMeta && selectedImageMeta.width && selectedImageMeta.height && areaW && areaH) {
        const directFit = selectedImageMeta.width >= areaW && selectedImageMeta.height >= areaH;
        const rotatedFit = selectedImageMeta.width >= areaH && selectedImageMeta.height >= areaW;
        if (!directFit && !rotatedFit) {
            // Non-blocking recommendation
            console.warn('Selected image may be below recommended 300 DPI for this print area.');
            alert(`Recommendation: Printify recommends ~300 DPI. Your image (${selectedImageMeta.width}×${selectedImageMeta.height}px) is smaller than the selected print area (${areaW}×${areaH}px). Consider using a higher-resolution image.`);
        }
    }
    renderProducts();
}

function toggleProduct(productId) {
    if (selectedProducts.has(productId)) {
        selectedProducts.delete(productId);
    } else {
        selectedProducts.add(productId);
    }
    
    updateSelectedCount();
    renderProducts();
}

function selectAllProducts() {
    const categoryFilter = document.getElementById('categoryFilter').value;
    const filteredProducts = categoryFilter 
        ? availableProducts.filter(p => p.category === categoryFilter)
        : availableProducts;
    
    filteredProducts.forEach(p => selectedProducts.add(p.id));
    updateSelectedCount();
    renderProducts();
}

function clearAllProducts() {
    selectedProducts.clear();
    updateSelectedCount();
    renderProducts();
}

function updateSelectedCount() {
    const count = selectedProducts.size;
    document.getElementById('selectedCount').textContent = `${count} products selected`;
    document.getElementById('createProductsBtn').disabled = count === 0 || !uploadedImageId;
}

// Create bulk products
async function createBulkProducts() {
    if (!uploadedImageId || selectedProducts.size === 0) return;
    
    const selectedProductList = availableProducts.filter(p => selectedProducts.has(p.id));
    const total = selectedProductList.length;
    let completed = 0;
    const results = [];
    
    showProgress('Creating products...', 0);
    
    for (const product of selectedProductList) {
        try {
            updateProgress(`Creating ${product.name}...`, (completed / total) * 100);
            
            const result = await createSingleProduct(product);
            results.push({ product, result, success: true });
            
        } catch (error) {
            console.error(`Failed to create ${product.name}:`, error);
            results.push({ product, result: error.message, success: false });
        }
        
        completed++;
        
        // Rate limiting: wait 1 second between requests
        if (completed < total) {
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
    
    hideProgress();
    showResults(results);
    showStep(3);
}

async function createSingleProduct(product) {
    // Use chosen provider/variant if set via modal
    const chosen = selectedPrintAreas[product.blueprint_id] || selectedPrintAreas[product.id];
    let printProviderId = chosen?.providerId || product.print_provider_id;
    let variantId = chosen?.variantId || product.variant_id;
    try {
        if (!printProviderId || !variantId) {
            const pv = await resolveProviderAndVariant(product.blueprint_id);
            printProviderId = pv.print_provider_id;
            variantId = pv.variant_id;
        }
    } catch (e) {
        console.warn('Provider/variant resolution failed, using defaults if present:', e);
    }

    const payload = {
        title: `${product.name} - Custom Design`,
        description: `Custom ${product.name} with your design`,
        blueprint_id: product.blueprint_id,
        print_provider_id: Number(printProviderId) || 1,
        variants: [
            {
                id: Number(variantId) || Number(product.variant_id) || 0,
                price: Math.round(product.price * 100) // Convert to cents
            }
        ],
        print_areas: [
            {
                variant_ids: [Number(variantId) || Number(product.variant_id) || 0],
                placeholders: [
                    {
                        position: 'front',
                        images: [
                            {
                                id: uploadedImageId,
                                x: 0.5,
                                y: 0.5,
                                scale: 1.0,
                                angle: 0
                            }
                        ]
                    }
                ]
            }
        ]
    };
    
    // Use existing Printify proxy with shop ID from session storage
    const shopId = sessionStorage.getItem('bulkSelectedShop') || getDefaultShopId();
    const response = await makeApiCall(`/shops/${shopId}/products.json`, {
        method: 'POST',
        body: payload
    });
    
    if (!response.success) {
        throw new Error(response.error || 'Product creation failed');
    }
    
    return response.data;
}

// Print Area Selection Modal Markup
</script>

<!-- Print Area Modal -->
<div class="modal fade" id="printAreaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-aspect-ratio"></i> Choose Print Area</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="paModalBody">
        <!-- Filled dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// Resolve a default print provider and a variant for a blueprint
async function resolveProviderAndVariant(blueprintId) {
    // Choose first provider, then first available variant
    const providersResp = await makeApiCall(`/catalog/blueprints/${blueprintId}/print_providers.json`, { method: 'GET' });
    if (!providersResp.success) throw new Error(providersResp.error || 'Failed to load providers');
    const providers = Array.isArray(providersResp.data?.data) ? providersResp.data.data : providersResp.data;
    const provider = providers && providers[0];
    if (!provider) throw new Error('No providers available for this blueprint');

    const detailsResp = await makeApiCall(`/catalog/blueprints/${blueprintId}/print_providers/${provider.id}.json`, { method: 'GET' });
    if (!detailsResp.success) throw new Error(detailsResp.error || 'Failed to load provider details');
    const details = detailsResp.data?.data || detailsResp.data;
    const firstVariant = Array.isArray(details?.variants) ? details.variants[0] : null;
    if (!firstVariant) throw new Error('No variants available for provider');

    return { print_provider_id: provider.id, variant_id: firstVariant.id };
}

// Fetch images from Printify Media Library
async function fetchMediaLibraryImages(page = 1, limit = 50) {
    try {
        const resp = await makeApiCall(`/uploads.json?page=${page}&limit=${limit}`, { method: 'GET' });
        if (!resp.success) throw new Error(resp.error || 'Failed to fetch media library');
        
        const images = Array.isArray(resp.data?.data) ? resp.data.data : resp.data;
        return images || [];
    } catch (e) {
        console.error('Error fetching media library:', e);
        return [];
    }
}

// Fetch details for a specific media library image
async function fetchMediaLibraryImage(imageId) {
    try {
        const resp = await makeApiCall(`/uploads/${imageId}.json`, { method: 'GET' });
        if (!resp.success) throw new Error(resp.error || 'Failed to fetch image details');
        
        return resp.data?.data || resp.data;
    } catch (e) {
        console.error(`Error fetching image ${imageId}:`, e);
        return null;
    }
}

// Show results
function showResults(results) {
    const container = document.getElementById('resultsContainer');
    const successful = results.filter(r => r.success).length;
    const failed = results.filter(r => !r.success).length;
    
    container.innerHTML = `
        <div class="alert alert-info">
            <h6><i class="bi bi-info-circle"></i> Bulk Creation Complete</h6>
            <p class="mb-0">
                <span class="badge bg-success">${successful} successful</span>
                <span class="badge bg-danger">${failed} failed</span>
            </p>
        </div>
        
        <div class="row">
            ${results.map(r => `
                <div class="col-md-6 mb-3">
                    <div class="card ${r.success ? 'border-success' : 'border-danger'}">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-${r.success ? 'check-circle text-success' : 'x-circle text-danger'}"></i>
                                ${r.product.name}
                            </h6>
                            <p class="card-text small">
                                ${r.success ? 'Product created successfully' : 'Error: ' + r.result}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="mt-4">
            <button class="btn btn-primary" onclick="startOver()">
                <i class="bi bi-arrow-clockwise"></i> Create More Products
            </button>
        </div>
    `;
}

// Utility functions
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

function showStep(stepNumber) {
    document.querySelectorAll('.step-container').forEach(step => {
        step.classList.remove('active');
    });
    document.getElementById(`step${stepNumber}`).classList.add('active');
}

function showProgress(title, percentage) {
    document.getElementById('progressTitle').textContent = title;
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressStatus').textContent = `${Math.round(percentage)}% complete`;
    document.getElementById('progressContainer').style.display = 'block';
}

function updateProgress(status, percentage) {
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressStatus').textContent = status;
}

function hideProgress() {
    document.getElementById('progressContainer').style.display = 'none';
}

function startOver() {
    // Reset state
    selectedProducts.clear();
    uploadedImageId = null;
    uploadedImageUrl = null;
    clearImage();
    updateSelectedCount();
    showStep(1);
}

function logout() {
    localStorage.removeItem('authToken');
    window.location.href = 'index.html';
}

// Media Library UI
let mediaCache = [];
let mediaModal;

function openMediaLibrary() {
    if (!mediaModal) {
        mediaModal = new bootstrap.Modal(document.getElementById('mediaLibraryModal'));
    }
    reloadMediaLibrary();
    mediaModal.show();
}

async function reloadMediaLibrary() {
    const grid = document.getElementById('mediaGrid');
    const empty = document.getElementById('mediaEmpty');
    grid.innerHTML = '<div class="text-center text-muted py-4">Loading…</div>';
    const images = await fetchMediaLibraryImages();
    mediaCache = images;
    if (!images.length) {
        grid.innerHTML = '';
        empty.classList.remove('d-none');
        return;
    }
    empty.classList.add('d-none');
    renderMediaGrid(images);
}

function filterMediaGrid() {
    const q = (document.getElementById('mediaSearch').value || '').toLowerCase();
    const filtered = !q ? mediaCache : mediaCache.filter(i => (i.file_name || '').toLowerCase().includes(q));
    renderMediaGrid(filtered);
}

function renderMediaGrid(items) {
    const grid = document.getElementById('mediaGrid');
    grid.innerHTML = items.map(i => `
        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
            <div class="card h-100" style="cursor:pointer" onclick="selectMediaImage('${i.id}', '${i.preview_url?.replace(/'/g, "&#39;") || ''}', '${(i.file_name || '').replace(/'/g, "&#39;")}')">
                <img src="${i.preview_url}" class="card-img-top" alt="${escapeHtml(i.file_name || i.id)}" style="height:120px; object-fit:contain; background:#f8fafc;">
                <div class="card-body p-2">
                    <div class="small text-truncate" title="${escapeHtml(i.file_name || i.id)}">${escapeHtml(i.file_name || i.id)}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function selectMediaImage(id, previewUrl, fileName) {
    // Set global state as if an image was uploaded
    uploadedImageId = id;
    uploadedImageUrl = previewUrl;
    // Fetch dimensions for DPI filtering
    fetchMediaLibraryImage(id).then(info => {
        if (info && typeof info.width === 'number' && typeof info.height === 'number') {
            selectedImageMeta = { width: info.width, height: info.height };
            console.log('[Media Library] size from API:', selectedImageMeta.width, 'x', selectedImageMeta.height, 'imageId:', id);
            const dims = document.getElementById('imageDims');
            if (dims) { dims.style.display = 'block'; dims.textContent = `Image size (Printify media): ${selectedImageMeta.width} × ${selectedImageMeta.height} px`; }
            renderProducts();
        }
    }).catch(()=>{});
    // Populate preview UI in Step 1
    const previewImg = document.getElementById('previewImage');
    const imageName = document.getElementById('imageName');
    const uploadContent = document.getElementById('uploadContent');
    const imagePreview = document.getElementById('imagePreview');
    if (previewImg) previewImg.src = previewUrl;
    if (imageName) imageName.textContent = fileName || id;
    if (uploadContent) uploadContent.style.display = 'none';
    if (imagePreview) imagePreview.style.display = 'block';
    // Enable next actions
    const createBtn = document.getElementById('createProductsBtn');
    if (createBtn) createBtn.disabled = selectedProducts.size === 0 ? true : false;
    const uploadBtn = document.getElementById('uploadBtn');
    if (uploadBtn) uploadBtn.disabled = true; // already in library
    
    // Close modal
    if (!mediaModal) mediaModal = new bootstrap.Modal(document.getElementById('mediaLibraryModal'));
    mediaModal.hide();
}
</script>
</body>
</html>
